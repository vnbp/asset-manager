<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Manager - H·ªá Th·ªëng Qu·∫£n L√Ω T√†i S·∫£n</title>

    <!-- PWA Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- QR Libraries -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .header h1 {
            color: #2563eb;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Navigation */
        .nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-btn {
            background: #2563eb;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            text-decoration: none;
            min-height: 60px;
        }

        .nav-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #059669;
        }

        /* Page Content */
        .page {
            display: none;
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .page.active {
            display: block;
        }

        .page h2 {
            color: #2563eb;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .btn-full {
            width: 100%;
            margin-bottom: 1rem;
        }

        /* QR Scanner */
        .scanner-container {
            background: #000;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 1rem;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #reader {
            width: 100%;
        }

        /* QR Result */
        .qr-result {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
        }

        .qr-result.success {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .qr-result h3 {
            color: #059669;
            margin-bottom: 1rem;
        }

        .asset-info {
            display: grid;
            gap: 0.5rem;
            margin: 1rem 0;
            text-align: left;
        }

        .asset-info div {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0.25rem;
        }

        /* Assets Grid */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .asset-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .asset-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .asset-code {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .asset-name {
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .asset-details {
            display: grid;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        /* QR Code Display */
        .qr-display {
            text-align: center;
            padding: 2rem;
            background: #f9fafb;
            border-radius: 0.75rem;
            margin: 1rem 0;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fed7aa;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .nav {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .assets-grid {
                grid-template-columns: 1fr;
            }

            .form-input,
            .btn {
                min-height: 48px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè¢ Asset Manager</h1>
            <p>H·ªá th·ªëng qu·∫£n l√Ω v√† ki·ªÉm k√™ t√†i s·∫£n v·ªõi QR Code</p>
        </div>

        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">
                üìä Dashboard
            </button>
            <button class="nav-btn" onclick="showPage('scanner')">
                üì± Qu√©t QR
            </button>
            <button class="nav-btn" onclick="showPage('assets')">
                üìã Danh s√°ch t√†i s·∫£n
            </button>
            <button class="nav-btn" onclick="showPage('qr-generator')">
                üéØ T·∫°o QR Code
            </button>
            <button class="nav-btn" onclick="showPage('settings')">
                ‚öôÔ∏è C√†i ƒë·∫∑t
            </button>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <h2>üìä Dashboard T·ªïng Quan</h2>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalAssets">0</div>
                    <div class="stat-label">T·ªïng s·ªë t√†i s·∫£n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="checkedAssets">0</div>
                    <div class="stat-label">ƒê√£ ki·ªÉm k√™</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uncheckedAssets">0</div>
                    <div class="stat-label">Ch∆∞a ki·ªÉm k√™</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressPercent">0%</div>
                    <div class="stat-label">Ti·∫øn ƒë·ªô ho√†n th√†nh</div>
                </div>
            </div>

            <div class="form-group">
                <button class="btn btn-primary btn-full" onclick="showPage('scanner')">
                    üì± B·∫Øt ƒë·∫ßu qu√©t QR Code
                </button>
                <button class="btn btn-success btn-full" onclick="showPage('assets')">
                    üìã Xem danh s√°ch t√†i s·∫£n
                </button>
                <button class="btn btn-warning btn-full" onclick="showPage('qr-generator')">
                    üéØ T·∫°o QR Code h√†ng lo·∫°t
                </button>
            </div>
        </div>

        <!-- Scanner Page -->
        <div id="scanner" class="page">
            <h2>üì± Qu√©t QR Code T√†i S·∫£n</h2>

            <div id="scannerAlert" class="alert alert-warning hidden">
                <strong>L∆∞u √Ω:</strong> Vui l√≤ng cho ph√©p truy c·∫≠p camera ƒë·ªÉ qu√©t QR code.
            </div>

            <div class="scanner-container" id="scannerContainer">
                <div id="reader"></div>
            </div>

            <div class="text-center">
                <button id="startScanBtn" class="btn btn-primary" onclick="startScanning()">
                    üé• B·∫Øt ƒë·∫ßu qu√©t
                </button>
                <button id="stopScanBtn" class="btn btn-warning hidden" onclick="stopScanning()">
                    üõë D·ª´ng qu√©t
                </button>
            </div>

            <div id="scanResult" class="hidden">
                <!-- K·∫øt qu·∫£ qu√©t s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>

        <!-- Assets Page -->
        <div id="assets" class="page">
            <h2>üìã Danh S√°ch T√†i S·∫£n</h2>

            <div class="form-group">
                <input type="text" id="searchInput" class="form-input" placeholder="üîç T√¨m ki·∫øm t√†i s·∫£n..."
                    onkeyup="searchAssets()">
            </div>

            <div class="form-group">
                <button class="btn btn-primary" onclick="loadAssets()">
                    üîÑ T·∫£i l·∫°i danh s√°ch
                </button>
                <button class="btn btn-success" onclick="exportData()">
                    üì§ Export Excel
                </button>
            </div>

            <div id="assetsLoading" class="text-center hidden">
                <div class="loading"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu t√†i s·∫£n...</p>
            </div>

            <div id="assetsList" class="assets-grid">
                <!-- Danh s√°ch t√†i s·∫£n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>

        <!-- QR Generator Page -->
        <div id="qr-generator" class="page">
            <h2>üéØ T·∫°o QR Code</h2>

            <div class="form-group">
                <label class="form-label">Nh·∫≠p m√£ t√†i s·∫£n:</label>
                <input type="text" id="assetCodeInput" class="form-input" placeholder="V√≠ d·ª•: HT001, TS002...">
            </div>

            <div class="form-group">
                <button class="btn btn-primary btn-full" onclick="generateSingleQR()">
                    üéØ T·∫°o QR Code ƒë∆°n l·∫ª
                </button>
                <button class="btn btn-success btn-full" onclick="generateAllQR()">
                    üì¶ T·∫°o QR Code h√†ng lo·∫°t
                </button>
            </div>

            <div id="qrProgress" class="hidden">
                <div class="alert alert-warning">
                    <div class="loading"></div>
                    ƒêang t·∫°o QR code... <span id="progressText">0/0</span>
                </div>
            </div>

            <div id="qrResult" class="qr-display hidden">
                <!-- QR code s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <h2>‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h2>

            <div class="form-group">
                <label class="form-label">üì° Google Apps Script URL:</label>
                <input type="url" id="apiUrl" class="form-input"
                    placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                <small style="color: #6b7280; margin-top: 0.5rem; display: block;">
                    Nh·∫≠p URL API t·ª´ Google Apps Script ƒë·ªÉ k·∫øt n·ªëi v·ªõi Google Sheets
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">üë§ T√™n ng∆∞·ªùi ki·ªÉm k√™:</label>
                <input type="text" id="userName" class="form-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            </div>

            <div class="form-group">
                <label class="form-label">üè¢ B·ªô ph·∫≠n:</label>
                <input type="text" id="userDepartment" class="form-input" placeholder="V√≠ d·ª•: K·∫ø to√°n, IT...">
            </div>

            <div class="form-group">
                <label class="form-label">üìç V·ªã tr√≠ l√†m vi·ªác:</label>
                <select id="userLocation" class="form-input">
                    <option value="">Ch·ªçn v·ªã tr√≠</option>
                    <option value="Produce">Produce</option>
                    <option value="SMT">SMT</option>
                    <option value="QTS">QTS</option>
                    <option value="QC">QC</option>
                    <option value="Warehouse">Warehouse</option>
                    <option value="100% Office">100% Office</option>
                    <option value="Canteen">Canteen</option>
                </select>
            </div>

            <div class="form-group">
                <button class="btn btn-primary" onclick="testConnection()">
                    üîå Test k·∫øt n·ªëi
                </button>
                <button class="btn btn-success" onclick="saveSettings()">
                    üíæ L∆∞u c√†i ƒë·∫∑t
                </button>
            </div>

            <div id="connectionStatus" class="hidden">
                <!-- Tr·∫°ng th√°i k·∫øt n·ªëi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>

            <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <button class="btn btn-warning btn-full" onclick="clearAllData()">
                    üóëÔ∏è X√≥a t·∫•t c·∫£ d·ªØ li·ªáu
                </button>
                <button class="btn btn-success btn-full" onclick="resetInventory()">
                    üîÑ Reset k·ª≥ ki·ªÉm k√™ m·ªõi
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // GLOBAL VARIABLES
        // ====================================

        let assets = [];
        let scanner = null;
        let isScanning = false;
        let currentUser = {
            name: '',
            department: '',
            location: ''
        };
        let settings = {
            apiUrl: '',
            qrSize: 256
        };

        // ====================================
        // PAGE NAVIGATION
        // ====================================

        function showPage(pageId) {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));

            // Hide all nav buttons active state
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));

            // Show target page
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');

            // Page-specific actions
            switch (pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'assets':
                    if (assets.length === 0) loadAssets();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // ====================================
        // SETTINGS MANAGEMENT
        // ====================================

        function loadSettings() {
            const savedSettings = localStorage.getItem('assetManagerSettings');
            const savedUser = localStorage.getItem('assetManagerUser');

            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.getElementById('apiUrl').value = settings.apiUrl || '';
            }

            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('userName').value = currentUser.name || '';
                document.getElementById('userDepartment').value = currentUser.department || '';
                document.getElementById('userLocation').value = currentUser.location || '';
            }
        }

        function saveSettings() {
            settings.apiUrl = document.getElementById('apiUrl').value;
            currentUser.name = document.getElementById('userName').value;
            currentUser.department = document.getElementById('userDepartment').value;
            currentUser.location = document.getElementById('userLocation').value;

            localStorage.setItem('assetManagerSettings', JSON.stringify(settings));
            localStorage.setItem('assetManagerUser', JSON.stringify(currentUser));

            showAlert('ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
        }

        async function testConnection() {
            if (!settings.apiUrl) {
                showAlert('Vui l√≤ng nh·∫≠p Google Apps Script URL', 'warning');
                return;
            }

            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = 'alert alert-warning';
            statusDiv.innerHTML = 'ƒêang ki·ªÉm tra k·∫øt n·ªëi...';
            statusDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${settings.apiUrl}?action=test`);
                const result = await response.json();

                if (result.success) {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng! API ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.';
                } else {
                    statusDiv.className = 'alert alert-error';
                    statusDiv.innerHTML = '‚ùå K·∫øt n·ªëi th·∫•t b·∫°i: ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }
            } catch (error) {
                statusDiv.className = 'alert alert-error';
                statusDiv.innerHTML = '‚ùå L·ªói k·∫øt n·ªëi: ' + error.message;
            }
        }

        // ====================================
        // ASSETS MANAGEMENT
        // ====================================

        async function loadAssets() {
            if (!settings.apiUrl) {
                showAlert('Vui l√≤ng c·∫•u h√¨nh Google Apps Script URL trong C√†i ƒë·∫∑t', 'warning');
                return;
            }

            document.getElementById('assetsLoading').classList.remove('hidden');

            try {
                const response = await fetch(`${settings.apiUrl}?action=getAssets`);
                const result = await response.json();

                if (result.success) {
                    assets = result.data || [];
                    displayAssets();
                    updateDashboard();
                    showAlert(`ƒê√£ t·∫£i ${assets.length} t√†i s·∫£n th√†nh c√¥ng!`, 'success');
                } else {
                    showAlert('L·ªói t·∫£i d·ªØ li·ªáu: ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi API: ' + error.message, 'error');
            } finally {
                document.getElementById('assetsLoading').classList.add('hidden');
            }
        }

        function displayAssets(assetsToShow = null) {
            const assetsList = document.getElementById('assetsList');
            const displayAssets = assetsToShow || assets;

            if (displayAssets.length === 0) {
                assetsList.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #6b7280;">
                        <h3>üì¶ Ch∆∞a c√≥ d·ªØ li·ªáu t√†i s·∫£n</h3>
                        <p>Vui l√≤ng c·∫•u h√¨nh Google Apps Script v√† t·∫£i d·ªØ li·ªáu</p>
                        <button class="btn btn-primary" onclick="showPage('settings')">‚öôÔ∏è C√†i ƒë·∫∑t ngay</button>
                    </div>
                `;
                return;
            }

            assetsList.innerHTML = displayAssets.map(asset => `
                <div class="asset-card">
                    <div class="asset-code">${asset.code || 'N/A'}</div>
                    <div class="asset-name">${asset.name_vi || asset.name_en || 'Kh√¥ng c√≥ t√™n'}</div>
                    <div class="asset-details">
                        <div><strong>Lo·∫°i:</strong> ${asset.category || 'N/A'}</div>
                        <div><strong>Model:</strong> ${asset.model || 'N/A'}</div>
                        <div><strong>V·ªã tr√≠:</strong> ${asset.location || 'N/A'}</div>
                        <div><strong>Serial:</strong> ${asset.serial || 'N/A'}</div>
                        <div><strong>Tr·∫°ng th√°i:</strong> 
                            <span style="color: ${asset.last_checked ? '#059669' : '#d97706'};">
                                ${asset.last_checked ? '‚úÖ ƒê√£ ki·ªÉm k√™' : '‚è≥ Ch∆∞a ki·ªÉm k√™'}
                            </span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="generateQRForAsset('${asset.code}')">
                            üéØ T·∫°o QR
                        </button>
                        ${asset.last_checked ? `
                            <small style="display: block; margin-top: 0.5rem; color: #6b7280;">
                                Ki·ªÉm k√™: ${new Date(asset.last_checked).toLocaleString('vi-VN')}<br>
                                B·ªüi: ${asset.checked_by || 'N/A'}
                            </small>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function searchAssets() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (!searchTerm) {
                displayAssets();
                return;
            }

            const filtered = assets.filter(asset => {
                return Object.values(asset).some(value =>
                    value && value.toString().toLowerCase().includes(searchTerm)
                );
            });

            displayAssets(filtered);
        }

        function updateDashboard() {
            const total = assets.length;
            const checked = assets.filter(asset => asset.last_checked).length;
            const unchecked = total - checked;
            const progress = total > 0 ? Math.round((checked / total) * 100) : 0;

            document.getElementById('totalAssets').textContent = total.toLocaleString();
            document.getElementById('checkedAssets').textContent = checked.toLocaleString();
            document.getElementById('uncheckedAssets').textContent = unchecked.toLocaleString();
            document.getElementById('progressPercent').textContent = progress + '%';
        }

        // ====================================
        // QR CODE SCANNER
        // ====================================

        async function startScanning() {
            try {
                if (!scanner) {
                    scanner = new Html5Qrcode("reader");
                }

                const cameras = await Html5Qrcode.getCameras();
                if (cameras.length === 0) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y camera');
                }

                // Prefer back camera
                const cameraId = cameras.find(camera =>
                    camera.label.toLowerCase().includes('back') ||
                    camera.label.toLowerCase().includes('environment')
                ) ? .id || cameras[0].id;

                await scanner.start(
                    cameraId, {
                        fps: 10,
                        qrbox: {
                            width: 250,
                            height: 250
                        }
                    },
                    (decodedText) => {
                        onQRScanned(decodedText);
                    }
                );

                isScanning = true;
                document.getElementById('startScanBtn').classList.add('hidden');
                document.getElementById('stopScanBtn').classList.remove('hidden');
                document.getElementById('scannerAlert').classList.add('hidden');

                showAlert('ƒê√£ b·∫Øt ƒë·∫ßu qu√©t QR code', 'success');

            } catch (error) {
                console.error('Scanner error:', error);
                showAlert('L·ªói camera: ' + error.message, 'error');
                document.getElementById('scannerAlert').classList.remove('hidden');
            }
        }

        async function stopScanning() {
            if (scanner && isScanning) {
                try {
                    await scanner.stop();
                    isScanning = false;

                    document.getElementById('startScanBtn').classList.remove('hidden');
                    document.getElementById('stopScanBtn').classList.add('hidden');

                    showAlert('ƒê√£ d·ª´ng qu√©t QR code', 'warning');
                } catch (error) {
                    console.error('Stop scanner error:', error);
                }
            }
        }

        function onQRScanned(qrData) {
            // Stop scanning temporarily
            stopScanning();

            // Find asset by QR data
            const assetCode = qrData.split('|')[0] || qrData;
            const asset = assets.find(a => a.code === assetCode);

            const resultDiv = document.getElementById('scanResult');

            if (asset) {
                resultDiv.innerHTML = `
                    <div class="qr-result success">
                        <h3>‚úÖ Qu√©t th√†nh c√¥ng!</h3>
                        <div class="asset-info">
                            <div><strong>M√£ t√†i s·∫£n:</strong> ${asset.code}</div>
                            <div><strong>T√™n:</strong> ${asset.name_vi || asset.name_en || 'N/A'}</div>
                            <div><strong>Lo·∫°i:</strong> ${asset.category || 'N/A'}</div>
                            <div><strong>Model:</strong> ${asset.model || 'N/A'}</div>
                            <div><strong>V·ªã tr√≠:</strong> ${asset.location || 'N/A'}</div>
                            <div><strong>Serial:</strong> ${asset.serial || 'N/A'}</div>
                            <div><strong>Tr·∫°ng th√°i:</strong> 
                                <span style="color: ${asset.last_checked ? '#059669' : '#d97706'};">
                                    ${asset.last_checked ? '‚úÖ ƒê√£ ki·ªÉm k√™' : '‚è≥ Ch∆∞a ki·ªÉm k√™'}
                                </span>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-success" onclick="confirmInventory('${asset.code}')">
                                ‚úÖ X√°c nh·∫≠n ki·ªÉm k√™
                            </button>
                            <button class="btn btn-primary" onclick="startScanning()">
                                üîÑ Ti·∫øp t·ª•c qu√©t
                            </button>
                        </div>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            } else {
                resultDiv.innerHTML = `
                    <div class="qr-result">
                        <h3>‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y t√†i s·∫£n</h3>
                        <p>M√£ QR: <strong>${qrData}</strong></p>
                        <p>Kh√¥ng t√¨m th·∫•y t√†i s·∫£n v·ªõi m√£ n√†y trong h·ªá th·ªëng.</p>
                        <button class="btn btn-primary" onclick="startScanning()">
                            üîÑ Qu√©t l·∫°i
                        </button>
                    </div>
                `;
                resultDiv.classList.remove('hidden');

                // Auto restart scanning after 3 seconds
                setTimeout(() => {
                    startScanning();
                }, 3000);
            }
        }

        async function confirmInventory(assetCode) {
            if (!currentUser.name) {
                showAlert('Vui l√≤ng c·∫•u h√¨nh th√¥ng tin ng∆∞·ªùi d√πng trong C√†i ƒë·∫∑t', 'warning');
                showPage('settings');
                return;
            }

            if (!settings.apiUrl) {
                showAlert('Vui l√≤ng c·∫•u h√¨nh Google Apps Script URL trong C√†i ƒë·∫∑t', 'warning');
                showPage('settings');
                return;
            }

            try {
                const inventoryData = {
                    assetCode: assetCode,
                    checkedBy: currentUser.name,
                    department: currentUser.department,
                    location: currentUser.location,
                    timestamp: new Date().toISOString(),
                    notes: 'Ki·ªÉm k√™ b·∫±ng QR Scanner'
                };

                const response = await fetch(settings.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateInventory',
                        data: inventoryData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local asset data
                    const asset = assets.find(a => a.code === assetCode);
                    if (asset) {
                        asset.last_checked = inventoryData.timestamp;
                        asset.checked_by = inventoryData.checkedBy;
                        asset.inventory_notes = inventoryData.notes;
                    }

                    showAlert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t ki·ªÉm k√™ th√†nh c√¥ng!', 'success');
                    updateDashboard();

                    // Auto continue scanning after 2 seconds
                    setTimeout(() => {
                        document.getElementById('scanResult').classList.add('hidden');
                        startScanning();
                    }, 2000);
                } else {
                    showAlert('‚ùå L·ªói c·∫≠p nh·∫≠t ki·ªÉm k√™: ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        // ====================================
        // QR CODE GENERATOR
        // ====================================

        function generateSingleQR() {
            const assetCode = document.getElementById('assetCodeInput').value.trim();
            if (!assetCode) {
                showAlert('Vui l√≤ng nh·∫≠p m√£ t√†i s·∫£n', 'warning');
                return;
            }

            const asset = assets.find(a => a.code === assetCode);
            if (!asset) {
                showAlert('Kh√¥ng t√¨m th·∫•y t√†i s·∫£n v·ªõi m√£: ' + assetCode, 'error');
                return;
            }

            generateQRForAsset(assetCode);
        }

        function generateQRForAsset(assetCode) {
            const asset = assets.find(a => a.code === assetCode);
            if (!asset) {
                showAlert('Kh√¥ng t√¨m th·∫•y t√†i s·∫£n v·ªõi m√£: ' + assetCode, 'error');
                return;
            }

            const resultDiv = document.getElementById('qrResult');
            resultDiv.innerHTML = `
                <h3>üéØ QR Code - ${assetCode}</h3>
                <div id="qrcode-${assetCode}" style="margin: 1rem auto;"></div>
                <p style="margin: 1rem 0; color: #6b7280;">${asset.name_vi || asset.name_en || 'Kh√¥ng c√≥ t√™n'}</p>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="downloadQR('${assetCode}')">
                        üì• T·∫£i xu·ªëng
                    </button>
                    <button class="btn btn-success" onclick="printQR('${assetCode}')">
                        üñ®Ô∏è In QR
                    </button>
                </div>
            `;

            resultDiv.classList.remove('hidden');

            // Generate QR code
            const qrData = `${asset.code}|${asset.name_vi || asset.name_en || ''}|${asset.location || ''}`;

            QRCode.toCanvas(
                document.getElementById(`qrcode-${assetCode}`),
                qrData, {
                    width: settings.qrSize || 256,
                    height: settings.qrSize || 256,
                    colorDark: '#000000',
                    colorLight: '#ffffff'
                },
                function (error) {
                    if (error) {
                        console.error('QR generation error:', error);
                        showAlert('L·ªói t·∫°o QR code: ' + error.message, 'error');
                    }
                }
            );
        }

        async function generateAllQR() {
            if (assets.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu t√†i s·∫£n ƒë·ªÉ t·∫°o QR', 'warning');
                return;
            }

            const progressDiv = document.getElementById('qrProgress');
            const progressText = document.getElementById('progressText');

            progressDiv.classList.remove('hidden');

            let qrDataCollection = [];

            for (let i = 0; i < assets.length; i++) {
                const asset = assets[i];
                progressText.textContent = `${i + 1}/${assets.length}`;

                try {
                    const qrData = `${asset.code}|${asset.name_vi || asset.name_en || ''}|${asset.location || ''}`;

                    // Generate QR as data URL
                    const qrCanvas = document.createElement('canvas');
                    await new Promise((resolve, reject) => {
                        QRCode.toCanvas(qrCanvas, qrData, {
                            width: 200,
                            height: 200,
                            colorDark: '#000000',
                            colorLight: '#ffffff'
                        }, (error) => {
                            if (error) reject(error);
                            else resolve();
                        });
                    });

                    qrDataCollection.push({
                        asset: asset,
                        qrDataUrl: qrCanvas.toDataURL()
                    });

                } catch (error) {
                    console.error(`Error generating QR for ${asset.code}:`, error);
                }

                // Small delay to prevent blocking
                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }

            progressDiv.classList.add('hidden');

            // Create download link for all QR codes
            createQRDownloadLink(qrDataCollection);

            showAlert(`‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng ${qrDataCollection.length} QR code!`, 'success');
        }

        function createQRDownloadLink(qrDataCollection) {
            const resultDiv = document.getElementById('qrResult');

            // Create a simple HTML page with all QR codes
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Codes - All Assets</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .qr-container { display: inline-block; margin: 10px; padding: 10px; border: 1px solid #ccc; text-align: center; }
                        .qr-container img { display: block; margin: 0 auto 10px; }
                        .asset-info { font-size: 12px; max-width: 200px; }
                        @media print { .qr-container { page-break-inside: avoid; } }
                    </style>
                </head>
                <body>
                    <h1>QR Codes - Asset Management</h1>
                    <p>T·ªïng s·ªë: ${qrDataCollection.length} QR codes</p>
            `;

            qrDataCollection.forEach(item => {
                htmlContent += `
                    <div class="qr-container">
                        <img src="${item.qrDataUrl}" alt="QR ${item.asset.code}">
                        <div class="asset-info">
                            <strong>${item.asset.code}</strong><br>
                            ${item.asset.name_vi || item.asset.name_en || ''}<br>
                            ${item.asset.location || ''}
                        </div>
                    </div>
                `;
            });

            htmlContent += '</body></html>';

            // Create download link
            const blob = new Blob([htmlContent], {
                type: 'text/html'
            });
            const url = URL.createObjectURL(blob);

            resultDiv.innerHTML = `
                <h3>‚úÖ QR Codes ƒë√£ t·∫°o xong!</h3>
                <p>ƒê√£ t·∫°o ${qrDataCollection.length} QR codes</p>
                <div style="margin: 1rem 0;">
                    <a href="${url}" download="QR_Codes_All_Assets.html" class="btn btn-primary">
                        üì• T·∫£i file HTML
                    </a>
                    <button class="btn btn-success" onclick="window.open('${url}', '_blank')">
                        üëÅÔ∏è Xem tr∆∞·ªõc & In
                    </button>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        function downloadQR(assetCode) {
            const canvas = document.querySelector(`#qrcode-${assetCode} canvas`);
            if (!canvas) return;

            const link = document.createElement('a');
            link.download = `QR_${assetCode}.png`;
            link.href = canvas.toDataURL();
            link.click();

            showAlert(`üì• ƒê√£ t·∫£i QR code cho ${assetCode}`, 'success');
        }

        function printQR(assetCode) {
            const canvas = document.querySelector(`#qrcode-${assetCode} canvas`);
            if (!canvas) return;

            const asset = assets.find(a => a.code === assetCode);

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print QR Code - ${assetCode}</title>
                        <style>
                            body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
                            .qr-container { border: 2px solid #000; padding: 20px; display: inline-block; }
                            .asset-info { margin-top: 10px; font-size: 14px; }
                        </style>
                    </head>
                    <body>
                        <div class="qr-container">
                            <img src="${canvas.toDataURL()}" alt="QR Code ${assetCode}">
                            <div class="asset-info">
                                <strong>${assetCode}</strong><br>
                                ${asset ? asset.name_vi || asset.name_en || '' : ''}<br>
                                ${asset ? asset.location || '' : ''}
                            </div>
                        </div>
                        <script>window.print(); window.close();
    </script>
</body>

</html>
`);

printWindow.document.close();
}

// ====================================
// DATA MANAGEMENT
// ====================================

function exportData() {
if (assets.length === 0) {
showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export', 'warning');
return;
}

// Create CSV content
const csvHeaders = [
'M√£ t√†i s·∫£n', 'T√™n (Ti·∫øng Vi·ªát)', 'T√™n (English)', 'Lo·∫°i', 'Model',
'Serial', 'V·ªã tr√≠', 'Gi√° tr·ªã', 'Tr·∫°ng th√°i ki·ªÉm k√™',
'Ng∆∞·ªùi ki·ªÉm k√™', 'Th·ªùi gian ki·ªÉm k√™', 'Ghi ch√∫'
];

const csvData = assets.map(asset => [
asset.code || '',
asset.name_vi || '',
asset.name_en || '',
asset.category || '',
asset.model || '',
asset.serial || '',
asset.location || '',
asset.value || '',
asset.last_checked ? 'ƒê√£ ki·ªÉm k√™' : 'Ch∆∞a ki·ªÉm k√™',
asset.checked_by || '',
asset.last_checked ? new Date(asset.last_checked).toLocaleString('vi-VN') : '',
asset.inventory_notes || ''
]);

const csvContent = [csvHeaders, ...csvData]
.map(row => row.map(cell => `"${cell}"`).join(','))
.join('\n');

// Add BOM for UTF-8
const BOM = '\uFEFF';
const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = `Asset_Export_${new Date().toISOString().split('T')[0]}.csv`;
link.click();

showAlert('üì§ ƒê√£ export d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
}

async function resetInventory() {
if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô d·ªØ li·ªáu ki·ªÉm k√™? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
return;
}

if (!settings.apiUrl) {
showAlert('Vui l√≤ng c·∫•u h√¨nh Google Apps Script URL trong C√†i ƒë·∫∑t', 'warning');
return;
}

try {
const response = await fetch(settings.apiUrl, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({
action: 'resetInventory',
resetBy: currentUser.name || 'System',
timestamp: new Date().toISOString()
})
});

const result = await response.json();

if (result.success) {
// Clear local inventory data
assets.forEach(asset => {
asset.last_checked = null;
asset.checked_by = null;
asset.inventory_notes = null;
});

updateDashboard();
displayAssets();

showAlert('üîÑ ƒê√£ reset d·ªØ li·ªáu ki·ªÉm k√™ th√†nh c√¥ng!', 'success');
} else {
showAlert('‚ùå L·ªói reset ki·ªÉm k√™: ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
}
} catch (error) {
showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
}
}

function clearAllData() {
if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu c·ª•c b·ªô? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
return;
}

localStorage.clear();
sessionStorage.clear();

// Reset variables
assets = [];
settings = { apiUrl: '', qrSize: 256 };
currentUser = { name: '', department: '', location: '' };

// Reset UI
updateDashboard();
displayAssets();
loadSettings();

showAlert('üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu c·ª•c b·ªô!', 'success');
}

// ====================================
// UTILITY FUNCTIONS
// ====================================

function showAlert(message, type = 'success') {
// Remove existing alerts
const existingAlert = document.querySelector('.alert-floating');
if (existingAlert) {
existingAlert.remove();
}

const alert = document.createElement('div');
alert.className = `alert alert-${type} alert-floating`;
alert.style.cssText = `
position: fixed;
top: 20px;
right: 20px;
z-index: 10000;
max-width: 350px;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
border-radius: 0.5rem;
`;

alert.innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <span>${message}</span>
    <button onclick="this.parentElement.parentElement.remove()"
        style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0; margin-left: 1rem; opacity: 0.7;">√ó</button>
</div>
`;

document.body.appendChild(alert);

// Auto remove after 5 seconds
setTimeout(() => {
if (alert.parentElement) {
alert.remove();
}
}, 5000);
}

// ====================================
// INITIALIZATION
// ====================================

document.addEventListener('DOMContentLoaded', function() {
console.log('Asset Manager initialized');
loadSettings();
updateDashboard();

// Load demo data if no API configured
if (!settings.apiUrl) {
showAlert('üëã Ch√†o m·ª´ng! Vui l√≤ng c·∫•u h√¨nh Google Apps Script trong ph·∫ßn C√†i ƒë·∫∑t ƒë·ªÉ b·∫Øt ƒë·∫ßu.', 'warning');
}

// Register service worker for PWA
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('sw.js').then(function(registration) {
console.log('Service Worker registered successfully:', registration.scope);
}).catch(function(error) {
console.log('Service Worker registration failed:', error);
});
}
});

// Prevent back button from breaking scanner
window.addEventListener('beforeunload', function() {
if (scanner && isScanning) {
stopScanning();
}
});

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
// Escape key to stop scanning
if (e.key === 'Escape' && isScanning) {
stopScanning();
}

// Ctrl/Cmd + S to save settings
if ((e.ctrlKey || e.metaKey) && e.key === 's') {
e.preventDefault();
if (document.getElementById('settings').classList.contains('active')) {
saveSettings();
}
}
});
</script>
</body>

</html>