<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Scanner Pro - Quét QR Liên Tục</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* Header với thông tin user và stats */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%);
            backdrop-filter: blur(20px);
            padding: 1rem;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .stats-mini {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .stat-label {
            opacity: 0.7;
            font-size: 0.7rem;
        }

        /* Camera Scanner */
        .scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #reader {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
        }

        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Scanning Overlay */
        .scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid #00ff88;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-frame::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #00ff88, transparent);
            animation: scanLine 2s linear infinite;
        }

        @keyframes scanLine {
            0% {
                top: -2px;
            }

            100% {
                top: 250px;
            }
        }

        .scan-corners {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
        }

        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #00ff88;
        }

        .corner.top-left {
            top: 0;
            left: 0;
            border-bottom: none;
            border-right: none;
            border-radius: 20px 0 0 0;
        }

        .corner.top-right {
            top: 0;
            right: 0;
            border-bottom: none;
            border-left: none;
            border-radius: 0 20px 0 0;
        }

        .corner.bottom-left {
            bottom: 0;
            left: 0;
            border-top: none;
            border-right: none;
            border-radius: 0 0 0 20px;
        }

        .corner.bottom-right {
            bottom: 0;
            right: 0;
            border-top: none;
            border-left: none;
            border-radius: 0 0 20px 0;
        }

        /* Scan Instruction */
        .scan-instruction {
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 60;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            border-radius: 30px;
            backdrop-filter: blur(20px);
        }

        /* Bottom Controls */
        .bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            z-index: 100;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .control-btn.primary {
            background: #007AFF;
        }

        .control-btn.danger {
            background: #FF3B30;
        }

        .control-btn.success {
            background: #34C759;
        }

        /* Quick Result Modal */
        .quick-result {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            color: #000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
        }

        .quick-result.show {
            transform: translateY(0);
        }

        .result-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 20px 20px 0 0;
        }

        .result-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .close-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: #e9ecef;
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
        }

        .result-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .asset-preview {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .asset-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 0.5rem;
        }

        .asset-name {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.checked {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.unchecked {
            background: #fff3cd;
            color: #856404;
        }

        .quick-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-item {
            font-size: 0.9rem;
        }

        .info-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .action-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .action-btn.primary {
            background: #007AFF;
            color: white;
        }

        .action-btn.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .action-btn.success {
            background: #34C759;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Edit Form */
        .edit-form {
            display: none;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            margin-top: 1rem;
        }

        .edit-form.show {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* Success Animation */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(52, 199, 89, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .success-content {
            text-align: center;
            color: white;
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Manual Input */
        .manual-input {
            position: fixed;
            top: 80px;
            left: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 1rem;
            border-radius: 15px;
            z-index: 150;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .manual-input.show {
            transform: translateY(0);
            opacity: 1;
        }

        .manual-input input {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .manual-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Navigation Tabs */
        .nav-tabs {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            display: flex;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            z-index: 90;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            border: none;
            background: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header {
                padding: 0.75rem;
            }

            .stats-mini {
                gap: 0.5rem;
            }

            .scan-frame {
                width: 200px;
                height: 200px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Sound Wave Animation */
        .sound-wave {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 250;
        }

        .wave {
            width: 4px;
            height: 20px;
            background: #00ff88;
            margin: 0 2px;
            display: inline-block;
            animation: wave 1s infinite;
        }

        .wave:nth-child(2) {
            animation-delay: 0.1s;
        }

        .wave:nth-child(3) {
            animation-delay: 0.2s;
        }

        .wave:nth-child(4) {
            animation-delay: 0.3s;
        }

        .wave:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes wave {

            0%,
            40%,
            100% {
                transform: scaleY(0.4);
            }

            20% {
                transform: scaleY(1);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="currentUser">Admin</span>
        </div>
        <div class="stats-mini">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Tổng</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="checkedCount">0</div>
                <div class="stat-label">Đã KK</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="progressPercent">0%</div>
                <div class="stat-label">Tiến độ</div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-mode="scan">
            <i class="fas fa-qrcode"></i> Quét QR
        </button>
        <button class="nav-tab" data-mode="list">
            <i class="fas fa-list"></i> Danh sách
        </button>
        <button class="nav-tab" data-mode="stats">
            <i class="fas fa-chart-bar"></i> Thống kê
        </button>
    </div>

    <!-- Manual Input -->
    <div class="manual-input" id="manualInput">
        <input type="text" id="manualCode" placeholder="Nhập mã tài sản thủ công..." autocomplete="off">
    </div>

    <!-- Scanner Container -->
    <div class="scanner-container">
        <div id="reader"></div>

        <!-- Scan Overlay -->
        <div class="scan-overlay">
            <div class="scan-frame">
                <div class="scan-corners">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                </div>
            </div>
        </div>

        <!-- Scan Instruction -->
        <div class="scan-instruction">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Đưa mã QR vào khung quét</div>
            <div style="opacity: 0.8; font-size: 0.9rem;">Camera sẽ tự động nhận diện</div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
        <div class="control-buttons">
            <button class="control-btn" id="flashBtn" title="Bật/tắt đèn flash">
                <i class="fas fa-lightbulb"></i>
            </button>
            <button class="control-btn" id="manualBtn" title="Nhập thủ công">
                <i class="fas fa-keyboard"></i>
            </button>
            <button class="control-btn primary" id="pauseBtn" title="Tạm dừng">
                <i class="fas fa-pause"></i>
            </button>
            <button class="control-btn" id="settingsBtn" title="Cài đặt">
                <i class="fas fa-cog"></i>
            </button>
            <button class="control-btn success" id="continueBtn" title="Tiếp tục quét" style="display: none;">
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>

    <!-- Quick Result Modal -->
    <div class="quick-result" id="quickResult">
        <div class="result-header">
            <div class="result-title">Thông tin tài sản</div>
            <button class="close-btn" id="closeResult">&times;</button>
        </div>
        <div class="result-body">
            <div class="asset-preview">
                <div>
                    <div class="asset-code" id="resultCode">TS001</div>
                    <div class="asset-name" id="resultName">Tên tài sản</div>
                    <span class="status-badge unchecked" id="resultStatus">
                        <i class="fas fa-clock"></i> Chưa kiểm kê
                    </span>
                </div>
            </div>

            <div class="quick-info" id="quickInfo">
                <!-- Dynamic content -->
            </div>

            <div class="action-buttons">
                <button class="action-btn success" id="quickCheckBtn">
                    <i class="fas fa-check"></i> Xác nhận KK
                </button>
                <button class="action-btn secondary" id="editBtn">
                    <i class="fas fa-edit"></i> Chỉnh sửa
                </button>
                <button class="action-btn primary" id="continueQRBtn">
                    <i class="fas fa-qrcode"></i> Tiếp tục quét
                </button>
            </div>

            <!-- Edit Form -->
            <div class="edit-form" id="editForm">
                <div class="form-group">
                    <label class="form-label">Tình trạng tài sản:</label>
                    <select class="form-input" id="assetCondition">
                        <option value="Tốt">Tốt</option>
                        <option value="Khá">Khá</option>
                        <option value="Kém">Kém</option>
                        <option value="Hỏng">Hỏng</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Vị trí hiện tại:</label>
                    <input type="text" class="form-input" id="assetLocation" placeholder="Nhập vị trí mới...">
                </div>
                <div class="form-group">
                    <label class="form-label">Ghi chú:</label>
                    <textarea class="form-input" id="assetNotes" rows="3" placeholder="Nhập ghi chú..."></textarea>
                </div>
                <div class="action-buttons">
                    <button class="action-btn secondary" id="cancelEditBtn">Hủy</button>
                    <button class="action-btn success" id="saveEditBtn">
                        <i class="fas fa-save"></i> Lưu & Tiếp tục
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div style="font-size: 1.5rem; font-weight: 600;">Đã kiểm kê!</div>
            <div style="opacity: 0.8; margin-top: 0.5rem;">Tự động tiếp tục quét sau 1 giây</div>
        </div>
    </div>

    <!-- Sound Wave -->
    <div class="sound-wave" id="soundWave">
        <span class="wave"></span>
        <span class="wave"></span>
        <span class="wave"></span>
        <span class="wave"></span>
        <span class="wave"></span>
    </div>

    <script>
        // Configuration
        const API_URL =
            "https://script.google.com/macros/s/AKfycbw6n97lmKxwgigftyQoaWqY1yLGHBxUPYvZIcwYORoTRCMQeWId9mk_2xWtMhrnOL-vrg/exec";

        // State
        let scanner = null;
        let isScanning = false;
        let currentAsset = null;
        let assets = [];
        let headers = [];
        let scanSound = null;

        // DOM Elements
        const elements = {
            reader: document.getElementById('reader'),
            quickResult: document.getElementById('quickResult'),
            resultCode: document.getElementById('resultCode'),
            resultName: document.getElementById('resultName'),
            resultStatus: document.getElementById('resultStatus'),
            quickInfo: document.getElementById('quickInfo'),
            editForm: document.getElementById('editForm'),
            manualInput: document.getElementById('manualInput'),
            manualCode: document.getElementById('manualCode'),
            successOverlay: document.getElementById('successOverlay'),
            soundWave: document.getElementById('soundWave'),

            // Stats
            totalCount: document.getElementById('totalCount'),
            checkedCount: document.getElementById('checkedCount'),
            progressPercent: document.getElementById('progressPercent'),

            // Buttons
            quickCheckBtn: document.getElementById('quickCheckBtn'),
            editBtn: document.getElementById('editBtn'),
            continueQRBtn: document.getElementById('continueQRBtn'),
            closeResult: document.getElementById('closeResult'),
            manualBtn: document.getElementById('manualBtn'),
            flashBtn: document.getElementById('flashBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            continueBtn: document.getElementById('continueBtn'),

            // Edit form
            assetCondition: document.getElementById('assetCondition'),
            assetLocation: document.getElementById('assetLocation'),
            assetNotes: document.getElementById('assetNotes'),
            saveEditBtn: document.getElementById('saveEditBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn')
        };

        // Initialize Scanner
        async function initScanner() {
            try {
                scanner = new Html5Qrcode("reader");

                const cameras = await Html5Qrcode.getCameras();
                if (cameras.length === 0) {
                    throw new Error('Không tìm thấy camera');
                }

                // Prefer back camera
                const cameraId = cameras.find(camera =>
                    camera.label.toLowerCase().includes('back') ||
                    camera.label.toLowerCase().includes('environment')
                ) ? .id || cameras[0].id;

                await scanner.start(
                    cameraId, {
                        fps: 10,
                        qrbox: {
                            width: 250,
                            height: 250
                        },
                        aspectRatio: 1.0
                    },
                    onQRScanned,
                    onScanError
                );

                isScanning = true;
                updateScanStatus();

            } catch (error) {
                console.error('Scanner error:', error);
                alert('Lỗi khởi tạo camera: ' + error.message);
            }
        }

        // QR Scan Success
        function onQRScanned(decodedText) {
            if (!isScanning) return;

            // Play scan sound
            playSuccessSound();

            // Show sound wave effect
            showSoundWave();

            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }

            // Find asset
            const asset = findAssetByCode(decodedText);

            if (asset) {
                showAssetResult(asset);
            } else {
                showNotFoundResult(decodedText);
            }
        }

        // QR Scan Error (silent)
        function onScanError(errorMessage) {
            // Silent handling for continuous scanning
        }

        // Find Asset by Code
        function findAssetByCode(code) {
            const codeIndex = headers.indexOf('Code');
            return assets.find(asset => asset[codeIndex] === code);
        }

        // Show Asset Result
        function showAssetResult(asset) {
            currentAsset = asset;

            const codeIndex = headers.indexOf('Code');
            const nameIndex = headers.indexOf('Tên tài sản Tiếng Việt');
            const checkedIndex = headers.indexOf('Check kiểm kê');
            const locationIndex = headers.indexOf('Vị trí');
            const modelIndex = headers.indexOf('Model');
            const serialIndex = headers.indexOf('Serial');

            const code = asset[codeIndex] || 'N/A';
            const name = asset[nameIndex] || 'Không có tên';
            const isChecked = asset[checkedIndex] === true;
            const location = asset[locationIndex] || 'N/A';
            const model = asset[modelIndex] || 'N/A';
            const serial = asset[serialIndex] || 'N/A';

            // Update result display
            elements.resultCode.textContent = code;
            elements.resultName.textContent = name;

            // Update status badge
            if (isChecked) {
                elements.resultStatus.className = 'status-badge checked';
                elements.resultStatus.innerHTML = '<i class="fas fa-check-circle"></i> Đã kiểm kê';
                elements.quickCheckBtn.innerHTML = '<i class="fas fa-redo"></i> Kiểm kê lại';
            } else {
                elements.resultStatus.className = 'status-badge unchecked';
                elements.resultStatus.innerHTML = '<i class="fas fa-clock"></i> Chưa kiểm kê';
                elements.quickCheckBtn.innerHTML = '<i class="fas fa-check"></i> Xác nhận KK';
            }

            // Update quick info
            elements.quickInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Vị trí</div>
                    <div class="info-value">${location}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Model</div>
                    <div class="info-value">${model}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Serial</div>
                    <div class="info-value">${serial}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Trạng thái</div>
                    <div class="info-value">${isChecked ? 'Đã kiểm kê' : 'Chưa kiểm kê'}</div>
                </div>
            `;

            // Fill edit form
            elements.assetLocation.value = location;

            // Show result modal
            elements.quickResult.classList.add('show');
        }

        // Show Not Found Result
        function showNotFoundResult(code) {
            elements.resultCode.textContent = code;
            elements.resultName.textContent = 'Không tìm thấy tài sản';
            elements.resultStatus.className = 'status-badge unchecked';
            elements.resultStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Không tồn tại';

            elements.quickInfo.innerHTML = `
                <div class="info-item" style="grid-column: 1/-1; text-align: center; color: #dc3545;">
                    <div class="info-value">Mã tài sản không có trong hệ thống</div>
                </div>
            `;

            // Hide action buttons except continue
            elements.quickCheckBtn.style.display = 'none';
            elements.editBtn.style.display = 'none';

            elements.quickResult.classList.add('show');

            // Auto close after 2 seconds
            setTimeout(() => {
                closeResult();
            }, 2000);
        }

        // Quick Check Asset
        async function quickCheckAsset() {
            if (!currentAsset) return;

            try {
                showLoading('Đang lưu kiểm kê...');

                // Update asset in local data
                const checkedIndex = headers.indexOf('Check kiểm kê');
                const timeIndex = headers.indexOf('Thời gian kiểm kê');
                const userIndex = headers.indexOf('Người kiểm kê');

                currentAsset[checkedIndex] = true;
                currentAsset[timeIndex] = new Date().toISOString();
                currentAsset[userIndex] = 'Scanner User';

                // Send to server
                await updateAssetOnServer(currentAsset);

                hideLoading();
                showSuccessAnimation();
                updateStats();

                // Auto continue scanning
                setTimeout(() => {
                    closeResult();
                    continueScan();
                }, 1500);

            } catch (error) {
                hideLoading();
                alert('Lỗi lưu dữ liệu: ' + error.message);
            }
        }

        // Save Edit
        async function saveEdit() {
            if (!currentAsset) return;

            try {
                showLoading('Đang lưu thay đổi...');

                // Update asset data
                const checkedIndex = headers.indexOf('Check kiểm kê');
                const timeIndex = headers.indexOf('Thời gian kiểm kê');
                const userIndex = headers.indexOf('Người kiểm kê');
                const locationIndex = headers.indexOf('Vị trí');
                const notesIndex = headers.indexOf('Ghi chú');

                currentAsset[checkedIndex] = true;
                currentAsset[timeIndex] = new Date().toISOString();
                currentAsset[userIndex] = 'Scanner User';
                currentAsset[locationIndex] = elements.assetLocation.value;
                if (notesIndex !== -1) {
                    currentAsset[notesIndex] = elements.assetNotes.value;
                }

                await updateAssetOnServer(currentAsset);

                hideLoading();
                showSuccessAnimation();
                updateStats();

                // Auto continue scanning
                setTimeout(() => {
                    closeResult();
                    continueScan();
                }, 1500);

            } catch (error) {
                hideLoading();
                alert('Lỗi lưu dữ liệu: ' + error.message);
            }
        }

        // Update Asset on Server
        async function updateAssetOnServer(asset) {
            // Mock API call - replace with actual implementation
            return new Promise((resolve) => {
                setTimeout(resolve, 500);
            });
        }

        // Show Success Animation
        function showSuccessAnimation() {
            elements.successOverlay.style.display = 'flex';
            setTimeout(() => {
                elements.successOverlay.style.display = 'none';
            }, 1500);
        }

        // Show/Hide Loading
        function showLoading(text = 'Đang xử lý...') {
            // Implementation for loading state
        }

        function hideLoading() {
            // Implementation for hiding loading state
        }

        // Play Success Sound
        function playSuccessSound() {
            // Create audio context for beep sound
            try {
                const audioContext = new(window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio not available');
            }
        }

        // Show Sound Wave Effect
        function showSoundWave() {
            elements.soundWave.style.display = 'block';
            setTimeout(() => {
                elements.soundWave.style.display = 'none';
            }, 1000);
        }

        // Update Stats
        function updateStats() {
            const total = assets.length;
            const checkedIndex = headers.indexOf('Check kiểm kê');
            const checked = assets.filter(asset => asset[checkedIndex] === true).length;
            const progress = total > 0 ? Math.round((checked / total) * 100) : 0;

            elements.totalCount.textContent = total;
            elements.checkedCount.textContent = checked;
            elements.progressPercent.textContent = progress + '%';
        }

        // Close Result Modal
        function closeResult() {
            elements.quickResult.classList.remove('show');
            elements.editForm.classList.remove('show');

            // Reset button visibility
            elements.quickCheckBtn.style.display = 'block';
            elements.editBtn.style.display = 'block';
        }

        // Continue Scan
        function continueScan() {
            if (!isScanning && scanner) {
                // Resume scanning if paused
                isScanning = true;
                updateScanStatus();
            }
        }

        // Pause/Resume Scanning
        function togglePause() {
            if (isScanning) {
                isScanning = false;
                elements.pauseBtn.style.display = 'none';
                elements.continueBtn.style.display = 'block';
            } else {
                isScanning = true;
                elements.pauseBtn.style.display = 'block';
                elements.continueBtn.style.display = 'none';
            }
            updateScanStatus();
        }

        // Update Scan Status
        function updateScanStatus() {
            // Visual feedback for scan status
        }

        // Toggle Manual Input
        function toggleManualInput() {
            const isVisible = elements.manualInput.classList.contains('show');

            if (isVisible) {
                elements.manualInput.classList.remove('show');
                elements.manualCode.blur();
            } else {
                elements.manualInput.classList.add('show');
                elements.manualCode.focus();
            }
        }

        // Handle Manual Input
        function handleManualInput() {
            const code = elements.manualCode.value.trim();
            if (code) {
                onQRScanned(code);
                elements.manualCode.value = '';
                elements.manualInput.classList.remove('show');
            }
        }

        // Load Demo Data
        function loadDemoData() {
            headers = ['Code', 'Tên tài sản Tiếng Việt', 'Model', 'Serial', 'Vị trí', 'Check kiểm kê',
                'Thời gian kiểm kê', 'Người kiểm kê', 'Ghi chú'
            ];

            assets = [
                ['TS001', 'Máy tính Dell OptiPlex', 'OptiPlex 7090', 'DL001234', 'Phòng IT', false, '', '', ''],
                ['TS002', 'Máy in HP LaserJet', 'LaserJet Pro M404n', 'HP567890', 'Phòng hành chính', true,
                    '2024-01-15', 'Admin', 'Hoạt động tốt'
                ],
                ['TS003', 'Bàn làm việc', 'Office Desk 120x60', 'DESK001', 'Phòng kế toán', false, '', '', ''],
                ['HT001', 'Hệ thống điều hòa', 'Daikin Inverter', 'AC2024001', 'Tầng 1', false, '', '', ''],
                ['TS004', 'Ghế xoay văn phòng', 'Executive Chair', 'CHAIR001', 'Phòng giám đốc', true, '2024-01-10',
                    'Manager', ''
                ]
            ];

            updateStats();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize demo data
            loadDemoData();

            // Initialize scanner
            initScanner();

            // Button event listeners
            elements.quickCheckBtn.addEventListener('click', quickCheckAsset);
            elements.editBtn.addEventListener('click', function () {
                elements.editForm.classList.add('show');
            });
            elements.continueQRBtn.addEventListener('click', function () {
                closeResult();
                continueScan();
            });
            elements.closeResult.addEventListener('click', closeResult);

            elements.saveEditBtn.addEventListener('click', saveEdit);
            elements.cancelEditBtn.addEventListener('click', function () {
                elements.editForm.classList.remove('show');
            });

            elements.manualBtn.addEventListener('click', toggleManualInput);
            elements.pauseBtn.addEventListener('click', togglePause);
            elements.continueBtn.addEventListener('click', togglePause);

            // Manual input enter key
            elements.manualCode.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    handleManualInput();
                }
            });

            // Close modal on background click
            elements.quickResult.addEventListener('click', function (e) {
                if (e.target === elements.quickResult) {
                    closeResult();
                }
            });

            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove(
                        'active'));
                    this.classList.add('active');

                    const mode = this.dataset.mode;
                    // Handle different modes (scan, list, stats)
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeResult();
                    elements.manualInput.classList.remove('show');
                }

                if (e.key === ' ' && !elements.manualInput.classList.contains('show')) {
                    e.preventDefault();
                    togglePause();
                }

                if (e.key === 'm' && !elements.manualInput.classList.contains('show')) {
                    e.preventDefault();
                    toggleManualInput();
                }
            });
        });

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle orientation change
        window.addEventListener('orientationchange', function () {
            setTimeout(() => {
                if (scanner && isScanning) {
                    scanner.stop().then(() => {
                        initScanner();
                    });
                }
            }, 500);
        });
    </script>
</body>

</html>