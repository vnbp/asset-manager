<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Asset Manager Pro - H·ªá Th·ªëng Qu·∫£n L√Ω T√†i S·∫£n</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.5s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: var(--white);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            gap: 10px;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            background: var(--light);
            color: var(--gray);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: #e5e7eb;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease;
        }

        .card-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--white) 0%, var(--light) 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray);
            margin-top: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--gray);
            color: var(--white);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            border: 3px dashed var(--primary);
            border-radius: 15px;
            background: var(--light);
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            background: #e0e7ff;
            border-color: var(--primary-dark);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light);
        }

        tr:hover {
            background: var(--light);
        }

        tr.checked {
            background: #d1fae5 !important;
        }

        .check-icon {
            color: var(--success);
            font-weight: bold;
        }

        .search-filter-container {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
        }

        .qr-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .qr-item {
            background: var(--white);
            border: 2px solid var(--light);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            page-break-inside: avoid;
        }

        .qr-item .qr-code {
            margin: 10px auto;
        }

        .qr-item .qr-info {
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.4;
            text-align: left;
        }

        .qr-item .qr-info strong {
            color: var(--primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin: 20px 0;
        }

        .info-label {
            font-weight: 600;
            color: var(--gray);
        }

        .info-value {
            color: var(--dark);
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .nav-tabs {
                padding: 5px;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .search-filter-container {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            table {
                font-size: 0.85rem;
            }

            th,
            td {
                padding: 8px;
            }
        }

        @media print {
            body {
                background: white;
            }

            .no-print {
                display: none !important;
            }

            .qr-item {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìã QR Asset Manager Pro</h1>
            <div class="subtitle">H·ªá th·ªëng qu·∫£n l√Ω t√†i s·∫£n th√¥ng minh v·ªõi QR Code</div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs no-print">
            <button class="nav-tab active" onclick="switchTab('dashboard')">
                üìä T·ªïng quan
            </button>
            <button class="nav-tab" onclick="switchTab('inventory')">
                üè¢ K·ª≥ ki·ªÉm k√™
            </button>
            <button class="nav-tab" onclick="switchTab('upload')">
                üìÅ Upload d·ªØ li·ªáu
            </button>
            <button class="nav-tab" onclick="switchTab('assets')">
                üìù Danh s√°ch t√†i s·∫£n
            </button>
            <button class="nav-tab" onclick="switchTab('scanner')">
                üì∑ Qu√©t QR
            </button>
            <button class="nav-tab" onclick="switchTab('qr-generator')">
                üè∑Ô∏è T·∫°o QR
            </button>
            <button class="nav-tab" onclick="switchTab('export')">
                üíæ Xu·∫•t b√°o c√°o
            </button>
        </div>

        <!-- Tab Contents -->

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-assets">0</div>
                    <div class="stat-label">T·ªïng s·ªë t√†i s·∫£n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="checked-assets">0</div>
                    <div class="stat-label">ƒê√£ ki·ªÉm k√™</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unchecked-assets">0</div>
                    <div class="stat-label">Ch∆∞a ki·ªÉm k√™</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="inventory-period">--</div>
                    <div class="stat-label">K·ª≥ ki·ªÉm k√™</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">üìà Ti·∫øn ƒë·ªô ki·ªÉm k√™</div>
                <div style="background: var(--light); border-radius: 10px; height: 30px; overflow: hidden;">
                    <div id="progress-bar"
                        style="background: linear-gradient(90deg, var(--success) 0%, #059669 100%); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        0%
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">üìä Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</div>
                <div id="recent-activities">
                    <p style="color: var(--gray);">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>
                </div>
            </div>
        </div>

        <!-- Inventory Period Tab -->
        <div id="inventory-tab" class="tab-content">
            <div class="card">
                <div class="card-header">‚öôÔ∏è Qu·∫£n l√Ω k·ª≥ ki·ªÉm k√™</div>

                <div class="form-group">
                    <label class="form-label">K·ª≥ ki·ªÉm k√™ hi·ªán t·∫°i</label>
                    <input type="text" id="current-period" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">T·∫°o k·ª≥ ki·ªÉm k√™ m·ªõi</label>
                    <input type="text" id="new-period" class="form-control" placeholder="V√≠ d·ª•: Q1/2025, Th√°ng 01/2025">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="createNewPeriod()">
                        ‚ûï T·∫°o k·ª≥ m·ªõi
                    </button>
                    <button class="btn btn-danger" onclick="resetInventory()">
                        üîÑ Reset ki·ªÉm k√™
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">üë• Ng∆∞·ªùi ki·ªÉm k√™</div>
                <div class="form-group">
                    <label class="form-label">T√™n ng∆∞·ªùi ki·ªÉm k√™</label>
                    <input type="text" id="inspector-name" class="form-control" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ki·ªÉm k√™">
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="saveInspector()">
                        üíæ L∆∞u
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content">
            <div class="card">
                <div class="card-header">üì§ Upload file Excel</div>

                <div class="file-upload">
                    <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                    <label for="file-input" class="file-upload-label">
                        <div>
                            <div style="font-size: 3rem;">üìÅ</div>
                            <div style="margin-top: 10px; font-weight: 500;">K√©o th·∫£ ho·∫∑c click ƒë·ªÉ ch·ªçn file Excel</div>
                            <div style="margin-top: 5px; color: var(--gray); font-size: 0.9rem;">H·ªó tr·ª£ .xlsx, .xls
                            </div>
                        </div>
                    </label>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        üì• Download Template Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Assets List Tab -->
        <div id="assets-tab" class="tab-content">
            <div class="card">
                <div class="card-header">üìã Danh s√°ch t√†i s·∫£n</div>

                <div class="search-filter-container">
                    <input type="text" id="search-input" class="form-control" placeholder="üîç T√¨m ki·∫øm..."
                        onkeyup="filterAssets()">

                    <select id="filter-type" class="form-control" onchange="filterAssets()">
                        <option value="">T·∫•t c·∫£ lo·∫°i</option>
                    </select>

                    <select id="filter-status" class="form-control" onchange="filterAssets()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="checked">ƒê√£ ki·ªÉm k√™</option>
                        <option value="unchecked">Ch∆∞a ki·ªÉm k√™</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="assets-table">
                        <thead>
                            <tr>
                                <th>‚úì</th>
                                <th>M√£ TS</th>
                                <th>T√™n t√†i s·∫£n</th>
                                <th>Lo·∫°i</th>
                                <th>Model</th>
                                <th>Serial</th>
                                <th>B·ªô ph·∫≠n</th>
                                <th>V·ªã tr√≠</th>
                                <th>Ng∆∞·ªùi KK</th>
                                <th>Th·ªùi gian KK</th>
                            </tr>
                        </thead>
                        <tbody id="assets-tbody">
                            <tr>
                                <td colspan="10" style="text-align: center; color: var(--gray);">
                                    Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng upload file Excel.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner-tab" class="tab-content">
            <div class="card">
                <div class="card-header">üì∑ Qu√©t m√£ QR</div>

                <div id="reader"></div>

                <div style="margin-top: 20px; text-align: center;">
                    <button id="start-scan-btn" class="btn btn-primary" onclick="startScanning()">
                        üé• B·∫Øt ƒë·∫ßu qu√©t
                    </button>
                    <button id="stop-scan-btn" class="btn btn-danger" style="display: none;" onclick="stopScanning()">
                        ‚èπÔ∏è D·ª´ng qu√©t
                    </button>
                </div>
            </div>
        </div>

        <!-- QR Generator Tab -->
        <div id="qr-generator-tab" class="tab-content">
            <div class="card">
                <div class="card-header">üè∑Ô∏è T·∫°o m√£ QR cho t√†i s·∫£n</div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateAllQR()">
                        üéØ T·∫°o QR cho t·∫•t c·∫£
                    </button>
                    <button class="btn btn-success" onclick="printQRCodes()">
                        üñ®Ô∏è In m√£ QR
                    </button>
                </div>

                <div id="qr-preview" class="qr-preview-grid"></div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
            <div class="card">
                <div class="card-header">üíæ Xu·∫•t b√°o c√°o</div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportToExcel()">
                        üìä Xu·∫•t Excel ƒë·∫ßy ƒë·ªß
                    </button>
                    <button class="btn btn-primary" onclick="exportCheckedAssets()">
                        ‚úÖ Xu·∫•t DS ƒë√£ ki·ªÉm k√™
                    </button>
                    <button class="btn btn-warning" onclick="exportUncheckedAssets()">
                        ‚ö†Ô∏è Xu·∫•t DS ch∆∞a ki·ªÉm k√™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Asset Details -->
    <div id="asset-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Chi ti·∫øt t√†i s·∫£n</span>
                <span class="modal-close" onclick="closeModal()">√ó</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // === PH·∫¶N 1: KH·ªûI T·∫†O BI·∫æN & DATABASE ===
        let assets = [];
        let currentPeriod = localStorage.getItem('currentPeriod') || '';
        let inspectorName = localStorage.getItem('inspectorName') || '';
        let html5QrcodeScanner = null;
        let db = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('AssetManagerDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    if (!db.objectStoreNames.contains('assets')) {
                        const store = db.createObjectStore('assets', {
                            keyPath: 'code'
                        });
                        store.createIndex('type', 'type', {
                            unique: false
                        });
                        store.createIndex('checked', 'checked', {
                            unique: false
                        });
                    }

                    if (!db.objectStoreNames.contains('activities')) {
                        const store = db.createObjectStore('activities', {
                            autoIncrement: true
                        });
                        store.createIndex('timestamp', 'timestamp', {
                            unique: false
                        });
                    }
                };
            });
        }

        // Initialize App
        async function initApp() {
            await initDB();
            await loadAssets();
            updateDashboard();
            document.getElementById('current-period').value = currentPeriod || 'Ch∆∞a thi·∫øt l·∫≠p';
            document.getElementById('inspector-name').value = inspectorName;
        }

        // === PH·∫¶N 2: DATABASE OPERATIONS ===

        // Load Assets from IndexedDB
        async function loadAssets() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['assets'], 'readonly');
                const store = transaction.objectStore('assets');
                const request = store.getAll();

                request.onsuccess = () => {
                    assets = request.result;
                    displayAssets();
                    updateFilters();
                    resolve();
                };

                request.onerror = () => reject(request.error);
            });
        }

        // Save Assets to IndexedDB
        async function saveAssets() {
            const transaction = db.transaction(['assets'], 'readwrite');
            const store = transaction.objectStore('assets');

            // Clear existing data
            await store.clear();

            // Add all assets
            for (const asset of assets) {
                store.add(asset);
            }

            return transaction.complete;
        }

        // Add Activity Log
        async function addActivity(action, details) {
            const transaction = db.transaction(['activities'], 'readwrite');
            const store = transaction.objectStore('activities');

            const activity = {
                action,
                details,
                timestamp: new Date().toISOString(),
                inspector: inspectorName
            };

            store.add(activity);
            displayRecentActivities();
        }

        // Display Recent Activities
        async function displayRecentActivities() {
            const transaction = db.transaction(['activities'], 'readonly');
            const store = transaction.objectStore('activities');
            const index = store.index('timestamp');
            const request = index.openCursor(null, 'prev');

            const activities = [];
            let count = 0; // === TI·∫æP T·ª§C PH·∫¶N JAVASCRIPT ===

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor && count < 10) {
                    activities.push(cursor.value);
                    count++;
                    cursor.continue();
                } else {
                    const
                        container = document.getElementById('recent-activities');
                    if (activities.length === 0) {
                        container.innerHTML = '<p style="color: var(--gray);">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>';
                    } else {
                        container.innerHTML = activities.map(a => `
                    <div
                        style="padding: 10px; border-left: 3px solid var(--primary); margin-bottom: 10px; background: var(--light); border-radius: 5px;">
                        <strong>${a.action}</strong> - ${a.details}
                        <div style="color: var(--gray); font-size: 0.85rem; margin-top: 5px;">
                            ${new Date(a.timestamp).toLocaleString('vi-VN')} ‚Ä¢ ${a.inspector || 'Kh√¥ng x√°c ƒë·ªãnh'}
                        </div>
                    </div>
                    `).join('');
                    }
                }
            };
        }

        // === PH·∫¶N 3: UI FUNCTIONS ===

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Add active class to clicked nav tab
            event.target.classList.add('active');

            // Stop scanner if leaving scanner tab
            if (tabName !== 'scanner' && html5QrcodeScanner) {
                stopScanning();
            }
        }

        // === PH·∫¶N 4: FILE HANDLING ===

        // File Upload Handler
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {
                        type: 'array'
                    });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1
                    });

                    // Parse data
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);

                    assets = rows.map(row => {
                        const asset = {};
                        headers.forEach((header, index) => {
                            asset[normalizeHeader(header)] = row[index] || '';
                        });
                        asset.checked = false;
                        asset.checkedBy = '';
                        asset.checkedTime = '';
                        return asset;
                    }).filter(a => a.code); // Filter out empty rows

                    await saveAssets();
                    displayAssets();
                    updateFilters();
                    updateDashboard();

                    await addActivity('Upload d·ªØ li·ªáu', `ƒê√£ upload ${assets.length} t√†i s·∫£n`);

                    alert(`‚úÖ ƒê√£ upload th√†nh c√¥ng ${assets.length} t√†i s·∫£n!`);

                    // Switch to assets tab
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove(
                    'active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    document.getElementById('assets-tab').classList.add('active');
                    document.querySelectorAll('.nav-tab')[3].classList.add('active');

                } catch (error) {
                    console.error('Error:', error);
                    alert('‚ùå L·ªói khi ƒë·ªçc file. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng!');
                } finally {
                    hideLoading();
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Normalize Header Names
        function normalizeHeader(header) {
            const mapping = {
                'Code': 'code',
                'M√£ t√†i s·∫£n': 'code',
                'T√™n t√†i s·∫£n Ti·∫øng Vi·ªát': 'nameVi',
                'T√™n ti·∫øng anh': 'nameEn',
                'Lo·∫°i': 'type',
                'Model': 'model',
                'Serial': 'serial',
                'Tech code': 'techCode',
                'Ng√†y b·∫Øt ƒë·∫ßu': 'startDate',
                'Th·ªùi gian s·ª≠ d·ª•ng': 'usagePeriod',
                'Ng√†y k·∫øt th√∫c': 'endDate',
                'Kh√°ch h√†ng': 'customer',
                'NCC': 'supplier',
                'Ngu·ªìn c·ªë': 'source',
                'B·ªô ph·∫≠n s·ª≠ d·ª•ng': 'department',
                'Gi√° tr·ªã ban ƒë·∫ßu': 'initialValue',
                'T√¨nh tr·∫°ng': 'status',
                'V·ªã tr√≠': 'location'
            };

            return mapping[header] || header.toLowerCase().replace(/\s+/g, '_');
        }

        // === PH·∫¶N 5: ASSET DISPLAY & FILTERING ===

        // Display Assets in Table
        function displayAssets() {
            const tbody = document.getElementById('assets-tbody');

            if (assets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: var(--gray);">
                            Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng upload file Excel.
                        </td>
                    </tr>
                    `;
                return;
            }

            tbody.innerHTML = assets.map(asset => `
                    <tr class="${asset.checked ? 'checked' : ''}" onclick="showAssetDetails('${asset.code}')">
                        <td>${asset.checked ? '<span class="check-icon">‚úì</span>' : ''}</td>
                        <td>${asset.code || ''}</td>
                        <td>${asset.nameVi || ''}</td>
                        <td>${asset.type || ''}</td>
                        <td>${asset.model || ''}</td>
                        <td>${asset.serial || ''}</td>
                        <td>${asset.department || ''}</td>
                        <td>${asset.location || ''}</td>
                        <td>${asset.checkedBy || ''}</td>
                        <td>${asset.checkedTime ? new Date(asset.checkedTime).toLocaleString('vi-VN') : ''}</td>
                    </tr>
                    `).join('');
        }

        // Update Filters
        function updateFilters() {
            const types = [...new Set(assets.map(a => a.type).filter(Boolean))];
            const typeSelect = document.getElementById('filter-type');

            typeSelect.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i</option>' +
                types.map(type => `<option value="${type}">${type}</option>`).join('');
        }

        // Filter Assets
        function filterAssets() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const statusFilter = document.getElementById('filter-status').value;

            const filtered = assets.filter(asset => {
                const matchSearch = !searchTerm ||
                    Object.values(asset).some(val =>
                        String(val).toLowerCase().includes(searchTerm)
                    );

                const matchType = !typeFilter || asset.type === typeFilter;

                const matchStatus = !statusFilter ||
                    (statusFilter === 'checked' && asset.checked) ||
                    (statusFilter === 'unchecked' && !asset.checked);

                return matchSearch && matchType && matchStatus;
            });

            const tbody = document.getElementById('assets-tbody');
            tbody.innerHTML = filtered.map(asset => `
                    <tr class="${asset.checked ? 'checked' : ''}" onclick="showAssetDetails('${asset.code}')">
                        <td>${asset.checked ? '<span class="check-icon">‚úì</span>' : ''}</td>
                        <td>${asset.code || ''}</td>
                        <td>${asset.nameVi || ''}</td>
                        <td>${asset.type || ''}</td>
                        <td>${asset.model || ''}</td>
                        <td>${asset.serial || ''}</td>
                        <td>${asset.department || ''}</td>
                        <td>${asset.location || ''}</td>
                        <td>${asset.checkedBy || ''}</td>
                        <td>${asset.checkedTime ? new Date(asset.checkedTime).toLocaleString('vi-VN') : ''}</td>
                    </tr>
                    `).join('');
        }

        // === PH·∫¶N 6: ASSET DETAILS MODAL ===

        // Show Asset Details Modal
        function showAssetDetails(code) {
            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            const modal = document.getElementById('asset-modal');
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = `
                    <div class="info-grid">
                        <div class="info-label">M√£ t√†i s·∫£n:</div>
                        <div class="info-value">${asset.code || ''}</div>

                        <div class="info-label">T√™n ti·∫øng Vi·ªát:</div>
                        <div class="info-value">${asset.nameVi || ''}</div>

                        <div class="info-label">T√™n ti·∫øng Anh:</div>
                        <div class="info-value">${asset.nameEn || ''}</div>

                        <div class="info-label">Lo·∫°i:</div>
                        <div class="info-value">${asset.type || ''}</div>

                        <div class="info-label">Model:</div>
                        <div class="info-value">${asset.model || ''}</div>

                        <div class="info-label">Serial:</div>
                        <div class="info-value">${asset.serial || ''}</div>

                        <div class="info-label">Tech Code:</div>
                        <div class="info-value">${asset.techCode || ''}</div>

                        <div class="info-label">B·ªô ph·∫≠n:</div>
                        <div class="info-value">${asset.department || ''}</div>

                        <div class="info-label">V·ªã tr√≠:</div>
                        <div class="info-value">
                            <input type="text" id="edit-location" class="form-control" value="${asset.location || ''}">
                        </div>

                        <div class="info-label">T√¨nh tr·∫°ng:</div>
                        <div class="info-value">
                            <select id="edit-status" class="form-control">
                                <option value="">Ch·ªçn t√¨nh tr·∫°ng</option>
                                <option value="T·ªët" ${asset.status==='T·ªët' ? 'selected' : '' }>T·ªët</option>
                                <option value="B√¨nh th∆∞·ªùng" ${asset.status==='B√¨nh th∆∞·ªùng' ? 'selected' : '' }>B√¨nh
                                    th∆∞·ªùng</option>
                                <option value="C·∫ßn s·ª≠a ch·ªØa" ${asset.status==='C·∫ßn s·ª≠a ch·ªØa' ? 'selected' : '' }>C·∫ßn s·ª≠a
                                    ch·ªØa</option>
                                <option value="H·ªèng" ${asset.status==='H·ªèng' ? 'selected' : '' }>H·ªèng</option>
                            </select>
                        </div>

                        <div class="info-label">Gi√° tr·ªã:</div>
                        <div class="info-value">${formatCurrency(asset.initialValue)}</div>

                        <div class="info-label">Ki·ªÉm k√™:</div>
                        <div class="info-value">${asset.checked ? '‚úÖ ƒê√£ ki·ªÉm k√™' : '‚ùå Ch∆∞a ki·ªÉm k√™'}</div>

                        ${asset.checked ? `
                        <div class="info-label">Ng∆∞·ªùi ki·ªÉm k√™:</div>
                        <div class="info-value">${asset.checkedBy}</div>

                        <div class="info-label">Th·ªùi gian:</div>
                        <div class="info-value">${new Date(asset.checkedTime).toLocaleString('vi-VN')}</div>
                        ` : ''}
                    </div>

                    <div class="btn-group" style="margin-top: 20px;">
                        ${!asset.checked ? `
                        <button class="btn btn-success" onclick="confirmInventory('${code}')">
                            ‚úÖ X√°c nh·∫≠n ki·ªÉm k√™
                        </button>
                        ` : `
                        <button class="btn btn-warning" onclick="cancelInventory('${code}')">
                            ‚Ü©Ô∏è H·ªßy ki·ªÉm k√™
                        </button>
                        `}
                        <button class="btn btn-primary" onclick="updateAsset('${code}')">
                            üíæ C·∫≠p nh·∫≠t th√¥ng tin
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">
                            ‚ùå ƒê√≥ng
                        </button>
                    </div>
                    `;

            modal.classList.add('active');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('asset-modal').classList.remove('active');
        }

        // === PH·∫¶N 7: INVENTORY FUNCTIONS ===

        // Confirm Inventory
        async function confirmInventory(code) {
            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            if (!inspectorName) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ki·ªÉm k√™ trong tab "K·ª≥ ki·ªÉm k√™"!');
                return;
            }

            asset.checked = true;
            asset.checkedBy = inspectorName;
            asset.checkedTime = new Date().toISOString();
            asset.location = document.getElementById('edit-location').value;
            asset.status = document.getElementById('edit-status').value;

            await saveAssets();
            displayAssets();
            updateDashboard();
            closeModal();

            await addActivity('Ki·ªÉm k√™', `ƒê√£ ki·ªÉm k√™ t√†i s·∫£n ${code}`);

            alert('‚úÖ ƒê√£ x√°c nh·∫≠n ki·ªÉm k√™ th√†nh c√¥ng!');
        }

        // Cancel Inventory
        async function cancelInventory(code) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ki·ªÉm k√™ t√†i s·∫£n n√†y?')) return;

            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            asset.checked = false;
            asset.checkedBy = '';
            asset.checkedTime = '';

            await saveAssets();
            displayAssets();
            updateDashboard();
            closeModal();

            await addActivity('H·ªßy ki·ªÉm k√™', `ƒê√£ h·ªßy ki·ªÉm k√™ t√†i s·∫£n ${code}`);
        }

        // Update Asset
        async function updateAsset(code) {
            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            asset.location = document.getElementById('edit-location').value;
            asset.status = document.getElementById('edit-status').value;

            await saveAssets();
            displayAssets();
            closeModal();

            await addActivity('C·∫≠p nh·∫≠t', `ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin t√†i s·∫£n ${code}`);

            alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
        }

        // === PH·∫¶N 8: DASHBOARD & STATISTICS ===

        // Update Dashboard
        function updateDashboard() {
            const total = assets.length;
            const checked = assets.filter(a => a.checked).length;
            const unchecked = total - checked;
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

            document.getElementById('total-assets').textContent = total;
            document.getElementById('checked-assets').textContent = checked;
            document.getElementById('unchecked-assets').textContent = unchecked;
            document.getElementById('inventory-period').textContent = currentPeriod || '--';

            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            displayRecentActivities();
        }

        // === PH·∫¶N 9: PERIOD MANAGEMENT ===

        // Create New Period
        async function createNewPeriod() {
            const newPeriod = document.getElementById('new-period').value.trim();

            if (!newPeriod) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n k·ª≥ ki·ªÉm k√™!');
                return;
            }

            if (currentPeriod && !confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o k·ª≥ m·ªõi "${newPeriod}"? K·ª≥ hi·ªán t·∫°i
                    "${currentPeriod}" s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i.`)) {
                return;
            }

            currentPeriod = newPeriod;
            localStorage.setItem('currentPeriod', currentPeriod);
            document.getElementById('current-period').value = currentPeriod;
            document.getElementById('new-period').value = '';

            await addActivity('T·∫°o k·ª≥ m·ªõi', `ƒê√£ t·∫°o k·ª≥ ki·ªÉm k√™ "${newPeriod}"`);
            updateDashboard();

            alert(`‚úÖ ƒê√£ t·∫°o k·ª≥ ki·ªÉm k√™ m·ªõi: ${newPeriod}`);
        }

        // Reset Inventory
        async function resetInventory() {
            if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: Vi·ªác reset s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu ki·ªÉm k√™ hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è X√ÅC NH·∫¨N L·∫¶N 2: T·∫•t c·∫£ d·ªØ li·ªáu ki·ªÉm k√™ s·∫Ω b·ªã x√≥a. Ti·∫øp t·ª•c?')) {
                return;
            }

            // Reset all assets
            assets.forEach(asset => {
                asset.checked = false;
                asset.checkedBy = '';
                asset.checkedTime = '';
            });

            await saveAssets();
            displayAssets();
            updateDashboard();

            await addActivity('Reset ki·ªÉm k√™', 'ƒê√£ reset to√†n b·ªô d·ªØ li·ªáu ki·ªÉm k√™');

            alert('‚úÖ ƒê√£ reset d·ªØ li·ªáu ki·ªÉm k√™ th√†nh c√¥ng!');
        }

        // Save Inspector Name
        function saveInspector() {
            inspectorName = document.getElementById('inspector-name').value.trim();

            if (!inspectorName) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ki·ªÉm k√™!');
                return;
            }

            localStorage.setItem('inspectorName', inspectorName);
            alert(`‚úÖ ƒê√£ l∆∞u ng∆∞·ªùi ki·ªÉm k√™: ${inspectorName}`);
        }

        // === PH·∫¶N 10: QR CODE GENERATION ===

        // Generate QR Codes
        function generateAllQR() {
            if (assets.length === 0) {
                alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu t√†i s·∫£n. Vui l√≤ng upload file Excel!');
                return;
            }

            const container = document.getElementById('qr-preview');
            container.innerHTML = '';

            assets.forEach(asset => {
                const qrItem = document.createElement('div');
                qrItem.className = 'qr-item';
                qrItem.innerHTML = `
                    <div class="qr-info">
                        <strong>M√£: ${asset.code}</strong><br>
                        ${asset.nameVi || ''}<br>
                        Model: ${asset.model || ''}<br>
                        Serial: ${asset.serial || ''}<br>
                        B·ªô ph·∫≠n: ${asset.department || ''}
                    </div>
                    <div id="qr-${asset.code}" class="qr-code"></div>
                    `;
                container.appendChild(qrItem);

                // Generate QR Code
                new QRCode(document.getElementById(`qr-${asset.code}`), {
                    text: asset.code,
                    width: 150,
                    height: 150,
                    correctLevel: QRCode.CorrectLevel.H
                });
            });

            alert(`‚úÖ ƒê√£ t·∫°o ${assets.length} m√£ QR!`);
        }

        // Print QR Codes
        function printQRCodes() {
            if (document.getElementById('qr-preview').innerHTML === '') {
                alert('‚ö†Ô∏è Vui l√≤ng t·∫°o m√£ QR tr∆∞·ªõc khi in!');
                return;
            }

            window.print();
        }

        // === PH·∫¶N 11: QR SCANNER ===

        // Start QR Scanner
        function startScanning() {
            const config = {
                fps: 10,
                qrbox: {
                    width: 250,
                    height: 250
                },
                aspectRatio: 1.0
            };

            html5QrcodeScanner = new Html5Qrcode("reader");

            html5QrcodeScanner.start({
                    facingMode: "environment"
                },
                config,
                onScanSuccess,
                onScanFailure
            );

            document.getElementById('start-scan-btn').style.display = 'none';
            document.getElementById('stop-scan-btn').style.display = 'inline-block';
        }

        // Stop QR Scanner
        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    document.getElementById('start-scan-btn').style.display = 'inline-block';
                    document.getElementById('stop-scan-btn').style.display = 'none';
                }).catch(err => console.error(err));
            }
        }

        // On Scan Success
        async function onScanSuccess(decodedText, decodedResult) {
            const asset = assets.find(a => a.code === decodedText);

            if (!asset) {
                alert(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y t√†i s·∫£n v·ªõi m√£: ${decodedText}`);
                return;
            }

            // Stop scanning temporarily
            stopScanning();

            // Show asset details
            showAssetDetails(decodedText);

            // Auto confirm if not checked
            if (!asset.checked) {
                setTimeout(() => {
                    if (confirm(`X√°c nh·∫≠n ki·ªÉm k√™ t√†i s·∫£n ${decodedText}?`)) {
                        confirmInventory(decodedText);
                    }
                }, 500);
            }
        }

        // On Scan Failure
        function onScanFailure(error) {
            // Ignore scan failures (continuous scanning)
        }

        // === PH·∫¶N 12: EXPORT FUNCTIONS ===

        // Export to Excel
        function exportToExcel() {
            if (assets.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }

            const exportData = assets.map(asset => ({
                'M√£ t√†i s·∫£n': asset.code,
                'T√™n ti·∫øng Vi·ªát': asset.nameVi,
                'T√™n ti·∫øng Anh': asset.nameEn,
                'Lo·∫°i': asset.type,
                'Model': asset.model,
                'Serial': asset.serial,
                'Tech Code': asset.techCode,
                'B·ªô ph·∫≠n': asset.department,
                'V·ªã tr√≠': asset.location,
                'T√¨nh tr·∫°ng': asset.status,
                'Gi√° tr·ªã': asset.initialValue,
                'ƒê√£ ki·ªÉm k√™': asset.checked ? 'C√≥' : 'Kh√¥ng',
                'Ng∆∞·ªùi ki·ªÉm k√™': asset.checkedBy,
                'Th·ªùi gian ki·ªÉm k√™': asset.checkedTime ? new Date(asset.checkedTime).toLocaleString(
                    'vi-VN') : ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'T√†i s·∫£n');

            const filename = `Kiem_ke_tai_san_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);

            addActivity('Xu·∫•t b√°o c√°o', `ƒê√£ xu·∫•t file Excel ${filename}`);
        }

        // Export Checked Assets
        function exportCheckedAssets() {
            const checkedAssets = assets.filter(a => a.checked);

            if (checkedAssets.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng c√≥ t√†i s·∫£n n√†o ƒë√£ ki·ªÉm k√™!');
                return;
            }

            const exportData = checkedAssets.map(asset => ({
                'M√£ t√†i s·∫£n': asset.code,
                'T√™n ti·∫øng Vi·ªát': asset.nameVi,
                'T√™n ti·∫øng Anh': asset.nameEn,
                'Lo·∫°i': asset.type,
                'Model': asset.model,
                'Serial': asset.serial,
                'B·ªô ph·∫≠n': asset.department,
                'V·ªã tr√≠': asset.location,
                'T√¨nh tr·∫°ng': asset.status,
                'Ng∆∞·ªùi ki·ªÉm k√™': asset.checkedBy,
                'Th·ªùi gian ki·ªÉm k√™': new Date(asset.checkedTime).toLocaleString('vi-VN')
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ƒê√£ ki·ªÉm k√™');

            const filename = `Da_kiem_ke_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Export Unchecked Assets
        function exportUncheckedAssets() {
            const uncheckedAssets = assets.filter(a => !a.checked);

            if (uncheckedAssets.length === 0) {
                alert('‚ö†Ô∏è T·∫•t c·∫£ t√†i s·∫£n ƒë√£ ƒë∆∞·ª£c ki·ªÉm k√™!');
                return;
            }

            const exportData = uncheckedAssets.map(asset => ({
                'M√£ t√†i s·∫£n': asset.code,
                'T√™n ti·∫øng Vi·ªát': asset.nameVi,
                'T√™n ti·∫øng Anh': asset.nameEn,
                'Lo·∫°i': asset.type,
                'Model': asset.model,
                'Serial': asset.serial,
                'B·ªô ph·∫≠n': asset.department,
                'V·ªã tr√≠': asset.location,
                'T√¨nh tr·∫°ng': asset.status
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ch∆∞a ki·ªÉm k√™');

            const filename = `Chua_kiem_ke_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // === PH·∫¶N 13: UTILITY FUNCTIONS ===

        // Download Template
        function downloadTemplate() {
            const template = [{
                'Code': 'TS001',
                'T√™n t√†i s·∫£n Ti·∫øng Vi·ªát': 'M√°y t√≠nh x√°ch tay',
                'T√™n ti·∫øng anh': 'Laptop',
                'Lo·∫°i': 'IT Equipment',
                'Model': 'Dell Latitude 5520',
                'Serial': 'ABC123456',
                'Tech code': 'IT-001',
                'Ng√†y b·∫Øt ƒë·∫ßu': '01/01/2024',
                'Th·ªùi gian s·ª≠ d·ª•ng': '48',
                'Ng√†y k·∫øt th√∫c': '01/01/2028',
                'Kh√°ch h√†ng': 'N·ªôi b·ªô',
                'NCC': 'Dell Vietnam',
                'Ngu·ªìn c·ªë': 'Mua m·ªõi',
                'B·ªô ph·∫≠n s·ª≠ d·ª•ng': 'IT Department',
                'Gi√° tr·ªã ban ƒë·∫ßu': '25000000',
                'T√¨nh tr·∫°ng': 'T·ªët',
                'V·ªã tr√≠': 'T·∫ßng 2 - Ph√≤ng IT'
            }];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');

            XLSX.writeFile(wb, 'Template_Import_Tai_San.xlsx');
        }

        // Format Currency
        function formatCurrency(value) {
            if (!value) return '';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(value);
        }

        // Show/Hide Loading
        function showLoading() { // Show/Hide Loading
            function showLoading() {
                document.getElementById('loading').classList.add('active');
            }

            function hideLoading() {
                document.getElementById('loading').classList.remove('active');
            }

            // === PH·∫¶N 14: EVENT LISTENERS & INITIALIZATION ===

            // Initialize app when DOM is ready
            document.addEventListener('DOMContentLoaded', initApp);

            // Handle window click for modal
            window.onclick = function (event) {
                const modal = document.getElementById('asset-modal');
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Prevent form submission on enter
            document.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });

            // Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
            }
    </script>
</body>

</html>