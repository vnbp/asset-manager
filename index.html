<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Asset Manager Pro - Hệ Thống Quản Lý Tài Sản</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.5s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: var(--white);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            gap: 10px;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            background: var(--light);
            color: var(--gray);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: #e5e7eb;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease;
        }

        .card-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--white) 0%, var(--light) 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray);
            margin-top: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--gray);
            color: var(--white);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            border: 3px dashed var(--primary);
            border-radius: 15px;
            background: var(--light);
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            background: #e0e7ff;
            border-color: var(--primary-dark);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light);
        }

        tr:hover {
            background: var(--light);
        }

        tr.checked {
            background: #d1fae5 !important;
        }

        .check-icon {
            color: var(--success);
            font-weight: bold;
        }

        .search-filter-container {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
        }

        .qr-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .qr-item {
            background: var(--white);
            border: 2px solid var(--light);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            page-break-inside: avoid;
        }

        .qr-item .qr-code {
            margin: 10px auto;
        }

        .qr-item .qr-info {
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.4;
            text-align: left;
        }

        .qr-item .qr-info strong {
            color: var(--primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin: 20px 0;
        }

        .info-label {
            font-weight: 600;
            color: var(--gray);
        }

        .info-value {
            color: var(--dark);
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .nav-tabs {
                padding: 5px;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .search-filter-container {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            table {
                font-size: 0.85rem;
            }

            th,
            td {
                padding: 8px;
            }
        }

        @media print {
            body {
                background: white;
            }

            .no-print {
                display: none !important;
            }

            .qr-item {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📋 QR Asset Manager Pro</h1>
            <div class="subtitle">Hệ thống quản lý tài sản thông minh với QR Code</div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs no-print">
            <button class="nav-tab active" onclick="switchTab('dashboard')">
                📊 Tổng quan
            </button>
            <button class="nav-tab" onclick="switchTab('inventory')">
                🏢 Kỳ kiểm kê
            </button>
            <button class="nav-tab" onclick="switchTab('upload')">
                📁 Upload dữ liệu
            </button>
            <button class="nav-tab" onclick="switchTab('assets')">
                📝 Danh sách tài sản
            </button>
            <button class="nav-tab" onclick="switchTab('scanner')">
                📷 Quét QR
            </button>
            <button class="nav-tab" onclick="switchTab('qr-generator')">
                🏷️ Tạo QR
            </button>
            <button class="nav-tab" onclick="switchTab('export')">
                💾 Xuất báo cáo
            </button>
        </div>

        <!-- Tab Contents -->

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-assets">0</div>
                    <div class="stat-label">Tổng số tài sản</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="checked-assets">0</div>
                    <div class="stat-label">Đã kiểm kê</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unchecked-assets">0</div>
                    <div class="stat-label">Chưa kiểm kê</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="inventory-period">--</div>
                    <div class="stat-label">Kỳ kiểm kê</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">📈 Tiến độ kiểm kê</div>
                <div style="background: var(--light); border-radius: 10px; height: 30px; overflow: hidden;">
                    <div id="progress-bar"
                        style="background: linear-gradient(90deg, var(--success) 0%, #059669 100%); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        0%
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">📊 Hoạt động gần đây</div>
                <div id="recent-activities">
                    <p style="color: var(--gray);">Chưa có hoạt động nào</p>
                </div>
            </div>
        </div>

        <!-- Inventory Period Tab -->
        <div id="inventory-tab" class="tab-content">
            <div class="card">
                <div class="card-header">⚙️ Quản lý kỳ kiểm kê</div>

                <div class="form-group">
                    <label class="form-label">Kỳ kiểm kê hiện tại</label>
                    <input type="text" id="current-period" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Tạo kỳ kiểm kê mới</label>
                    <input type="text" id="new-period" class="form-control" placeholder="Ví dụ: Q1/2025, Tháng 01/2025">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="createNewPeriod()">
                        ➕ Tạo kỳ mới
                    </button>
                    <button class="btn btn-danger" onclick="resetInventory()">
                        🔄 Reset kiểm kê
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">👥 Người kiểm kê</div>
                <div class="form-group">
                    <label class="form-label">Tên người kiểm kê</label>
                    <input type="text" id="inspector-name" class="form-control" placeholder="Nhập tên người kiểm kê">
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="saveInspector()">
                        💾 Lưu
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content">
            <div class="card">
                <div class="card-header">📤 Upload file Excel</div>

                <div class="file-upload">
                    <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                    <label for="file-input" class="file-upload-label">
                        <div>
                            <div style="font-size: 3rem;">📁</div>
                            <div style="margin-top: 10px; font-weight: 500;">Kéo thả hoặc click để chọn file Excel</div>
                            <div style="margin-top: 5px; color: var(--gray); font-size: 0.9rem;">Hỗ trợ .xlsx, .xls
                            </div>
                        </div>
                    </label>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        📥 Download Template Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Assets List Tab -->
        <div id="assets-tab" class="tab-content">
            <div class="card">
                <div class="card-header">📋 Danh sách tài sản</div>

                <div class="search-filter-container">
                    <input type="text" id="search-input" class="form-control" placeholder="🔍 Tìm kiếm..."
                        onkeyup="filterAssets()">

                    <select id="filter-type" class="form-control" onchange="filterAssets()">
                        <option value="">Tất cả loại</option>
                    </select>

                    <select id="filter-status" class="form-control" onchange="filterAssets()">
                        <option value="">Tất cả trạng thái</option>
                        <option value="checked">Đã kiểm kê</option>
                        <option value="unchecked">Chưa kiểm kê</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="assets-table">
                        <thead>
                            <tr>
                                <th>✓</th>
                                <th>Mã TS</th>
                                <th>Tên tài sản</th>
                                <th>Loại</th>
                                <th>Model</th>
                                <th>Serial</th>
                                <th>Bộ phận</th>
                                <th>Vị trí</th>
                                <th>Người KK</th>
                                <th>Thời gian KK</th>
                            </tr>
                        </thead>
                        <tbody id="assets-tbody">
                            <tr>
                                <td colspan="10" style="text-align: center; color: var(--gray);">
                                    Chưa có dữ liệu. Vui lòng upload file Excel.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner-tab" class="tab-content">
            <div class="card">
                <div class="card-header">📷 Quét mã QR</div>

                <div id="reader"></div>

                <div style="margin-top: 20px; text-align: center;">
                    <button id="start-scan-btn" class="btn btn-primary" onclick="startScanning()">
                        🎥 Bắt đầu quét
                    </button>
                    <button id="stop-scan-btn" class="btn btn-danger" style="display: none;" onclick="stopScanning()">
                        ⏹️ Dừng quét
                    </button>
                </div>
            </div>
        </div>

        <!-- QR Generator Tab -->
        <div id="qr-generator-tab" class="tab-content">
            <div class="card">
                <div class="card-header">🏷️ Tạo mã QR cho tài sản</div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateAllQR()">
                        🎯 Tạo QR cho tất cả
                    </button>
                    <button class="btn btn-success" onclick="printQRCodes()">
                        🖨️ In mã QR
                    </button>
                </div>

                <div id="qr-preview" class="qr-preview-grid"></div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
            <div class="card">
                <div class="card-header">💾 Xuất báo cáo</div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportToExcel()">
                        📊 Xuất Excel đầy đủ
                    </button>
                    <button class="btn btn-primary" onclick="exportCheckedAssets()">
                        ✅ Xuất DS đã kiểm kê
                    </button>
                    <button class="btn btn-warning" onclick="exportUncheckedAssets()">
                        ⚠️ Xuất DS chưa kiểm kê
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Asset Details -->
    <div id="asset-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Chi tiết tài sản</span>
                <span class="modal-close" onclick="closeModal()">×</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // === PHẦN 1: KHỞI TẠO BIẾN & DATABASE ===
        let assets = [];
        let currentPeriod = localStorage.getItem('currentPeriod') || '';
        let inspectorName = localStorage.getItem('inspectorName') || '';
        let html5QrcodeScanner = null;
        let db = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('AssetManagerDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    if (!db.objectStoreNames.contains('assets')) {
                        const store = db.createObjectStore('assets', {
                            keyPath: 'code'
                        });
                        store.createIndex('type', 'type', {
                            unique: false
                        });
                        store.createIndex('checked', 'checked', {
                            unique: false
                        });
                    }

                    if (!db.objectStoreNames.contains('activities')) {
                        const store = db.createObjectStore('activities', {
                            autoIncrement: true
                        });
                        store.createIndex('timestamp', 'timestamp', {
                            unique: false
                        });
                    }
                };
            });
        }

        // Initialize App
        async function initApp() {
            await initDB();
            await loadAssets();
            updateDashboard();
            document.getElementById('current-period').value = currentPeriod || 'Chưa thiết lập';
            document.getElementById('inspector-name').value = inspectorName;
        }

        // === PHẦN 2: DATABASE OPERATIONS ===

        // Load Assets from IndexedDB
        async function loadAssets() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['assets'], 'readonly');
                const store = transaction.objectStore('assets');
                const request = store.getAll();

                request.onsuccess = () => {
                    assets = request.result;
                    displayAssets();
                    updateFilters();
                    resolve();
                };

                request.onerror = () => reject(request.error);
            });
        }

        // Save Assets to IndexedDB
        async function saveAssets() {
            const transaction = db.transaction(['assets'], 'readwrite');
            const store = transaction.objectStore('assets');

            // Clear existing data
            await store.clear();

            // Add all assets
            for (const asset of assets) {
                store.add(asset);
            }

            return transaction.complete;
        }

        // Add Activity Log
        async function addActivity(action, details) {
            const transaction = db.transaction(['activities'], 'readwrite');
            const store = transaction.objectStore('activities');

            const activity = {
                action,
                details,
                timestamp: new Date().toISOString(),
                inspector: inspectorName
            };

            store.add(activity);
            displayRecentActivities();
        }

        // Display Recent Activities
        async function displayRecentActivities() {
            const transaction = db.transaction(['activities'], 'readonly');
            const store = transaction.objectStore('activities');
            const index = store.index('timestamp');
            const request = index.openCursor(null, 'prev');

            const activities = [];
            let count = 0; // === TIẾP TỤC PHẦN JAVASCRIPT ===

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor && count < 10) {
                    activities.push(cursor.value);
                    count++;
                    cursor.continue();
                } else {
                    const
                        container = document.getElementById('recent-activities');
                    if (activities.length === 0) {
                        container.innerHTML = '<p style="color: var(--gray);">Chưa có hoạt động nào</p>';
                    } else {
                        container.innerHTML = activities.map(a => `
                    <div
                        style="padding: 10px; border-left: 3px solid var(--primary); margin-bottom: 10px; background: var(--light); border-radius: 5px;">
                        <strong>${a.action}</strong> - ${a.details}
                        <div style="color: var(--gray); font-size: 0.85rem; margin-top: 5px;">
                            ${new Date(a.timestamp).toLocaleString('vi-VN')} • ${a.inspector || 'Không xác định'}
                        </div>
                    </div>
                    `).join('');
                    }
                }
            };
        }

        // === PHẦN 3: UI FUNCTIONS ===

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Add active class to clicked nav tab
            event.target.classList.add('active');

            // Stop scanner if leaving scanner tab
            if (tabName !== 'scanner' && html5QrcodeScanner) {
                stopScanning();
            }
        }

        // === PHẦN 4: FILE HANDLING ===

        // File Upload Handler
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {
                        type: 'array'
                    });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1
                    });

                    // Parse data
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);

                    assets = rows.map(row => {
                        const asset = {};
                        headers.forEach((header, index) => {
                            asset[normalizeHeader(header)] = row[index] || '';
                        });
                        asset.checked = false;
                        asset.checkedBy = '';
                        asset.checkedTime = '';
                        return asset;
                    }).filter(a => a.code); // Filter out empty rows

                    await saveAssets();
                    displayAssets();
                    updateFilters();
                    updateDashboard();

                    await addActivity('Upload dữ liệu', `Đã upload ${assets.length} tài sản`);

                    alert(`✅ Đã upload thành công ${assets.length} tài sản!`);

                    // Switch to assets tab
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove(
                    'active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    document.getElementById('assets-tab').classList.add('active');
                    document.querySelectorAll('.nav-tab')[3].classList.add('active');

                } catch (error) {
                    console.error('Error:', error);
                    alert('❌ Lỗi khi đọc file. Vui lòng kiểm tra lại định dạng!');
                } finally {
                    hideLoading();
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Normalize Header Names
        function normalizeHeader(header) {
            const mapping = {
                'Code': 'code',
                'Mã tài sản': 'code',
                'Tên tài sản Tiếng Việt': 'nameVi',
                'Tên tiếng anh': 'nameEn',
                'Loại': 'type',
                'Model': 'model',
                'Serial': 'serial',
                'Tech code': 'techCode',
                'Ngày bắt đầu': 'startDate',
                'Thời gian sử dụng': 'usagePeriod',
                'Ngày kết thúc': 'endDate',
                'Khách hàng': 'customer',
                'NCC': 'supplier',
                'Nguồn cố': 'source',
                'Bộ phận sử dụng': 'department',
                'Giá trị ban đầu': 'initialValue',
                'Tình trạng': 'status',
                'Vị trí': 'location'
            };

            return mapping[header] || header.toLowerCase().replace(/\s+/g, '_');
        }

        // === PHẦN 5: ASSET DISPLAY & FILTERING ===

        // Display Assets in Table
        function displayAssets() {
            const tbody = document.getElementById('assets-tbody');

            if (assets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: var(--gray);">
                            Chưa có dữ liệu. Vui lòng upload file Excel.
                        </td>
                    </tr>
                    `;
                return;
            }

            tbody.innerHTML = assets.map(asset => `
                    <tr class="${asset.checked ? 'checked' : ''}" onclick="showAssetDetails('${asset.code}')">
                        <td>${asset.checked ? '<span class="check-icon">✓</span>' : ''}</td>
                        <td>${asset.code || ''}</td>
                        <td>${asset.nameVi || ''}</td>
                        <td>${asset.type || ''}</td>
                        <td>${asset.model || ''}</td>
                        <td>${asset.serial || ''}</td>
                        <td>${asset.department || ''}</td>
                        <td>${asset.location || ''}</td>
                        <td>${asset.checkedBy || ''}</td>
                        <td>${asset.checkedTime ? new Date(asset.checkedTime).toLocaleString('vi-VN') : ''}</td>
                    </tr>
                    `).join('');
        }

        // Update Filters
        function updateFilters() {
            const types = [...new Set(assets.map(a => a.type).filter(Boolean))];
            const typeSelect = document.getElementById('filter-type');

            typeSelect.innerHTML = '<option value="">Tất cả loại</option>' +
                types.map(type => `<option value="${type}">${type}</option>`).join('');
        }

        // Filter Assets
        function filterAssets() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const statusFilter = document.getElementById('filter-status').value;

            const filtered = assets.filter(asset => {
                const matchSearch = !searchTerm ||
                    Object.values(asset).some(val =>
                        String(val).toLowerCase().includes(searchTerm)
                    );

                const matchType = !typeFilter || asset.type === typeFilter;

                const matchStatus = !statusFilter ||
                    (statusFilter === 'checked' && asset.checked) ||
                    (statusFilter === 'unchecked' && !asset.checked);

                return matchSearch && matchType && matchStatus;
            });

            const tbody = document.getElementById('assets-tbody');
            tbody.innerHTML = filtered.map(asset => `
                    <tr class="${asset.checked ? 'checked' : ''}" onclick="showAssetDetails('${asset.code}')">
                        <td>${asset.checked ? '<span class="check-icon">✓</span>' : ''}</td>
                        <td>${asset.code || ''}</td>
                        <td>${asset.nameVi || ''}</td>
                        <td>${asset.type || ''}</td>
                        <td>${asset.model || ''}</td>
                        <td>${asset.serial || ''}</td>
                        <td>${asset.department || ''}</td>
                        <td>${asset.location || ''}</td>
                        <td>${asset.checkedBy || ''}</td>
                        <td>${asset.checkedTime ? new Date(asset.checkedTime).toLocaleString('vi-VN') : ''}</td>
                    </tr>
                    `).join('');
        }

        // === PHẦN 6: ASSET DETAILS MODAL ===

        // Show Asset Details Modal
        function showAssetDetails(code) {
            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            const modal = document.getElementById('asset-modal');
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = `
                    <div class="info-grid">
                        <div class="info-label">Mã tài sản:</div>
                        <div class="info-value">${asset.code || ''}</div>

                        <div class="info-label">Tên tiếng Việt:</div>
                        <div class="info-value">${asset.nameVi || ''}</div>

                        <div class="info-label">Tên tiếng Anh:</div>
                        <div class="info-value">${asset.nameEn || ''}</div>

                        <div class="info-label">Loại:</div>
                        <div class="info-value">${asset.type || ''}</div>

                        <div class="info-label">Model:</div>
                        <div class="info-value">${asset.model || ''}</div>

                        <div class="info-label">Serial:</div>
                        <div class="info-value">${asset.serial || ''}</div>

                        <div class="info-label">Tech Code:</div>
                        <div class="info-value">${asset.techCode || ''}</div>

                        <div class="info-label">Bộ phận:</div>
                        <div class="info-value">${asset.department || ''}</div>

                        <div class="info-label">Vị trí:</div>
                        <div class="info-value">
                            <input type="text" id="edit-location" class="form-control" value="${asset.location || ''}">
                        </div>

                        <div class="info-label">Tình trạng:</div>
                        <div class="info-value">
                            <select id="edit-status" class="form-control">
                                <option value="">Chọn tình trạng</option>
                                <option value="Tốt" ${asset.status==='Tốt' ? 'selected' : '' }>Tốt</option>
                                <option value="Bình thường" ${asset.status==='Bình thường' ? 'selected' : '' }>Bình
                                    thường</option>
                                <option value="Cần sửa chữa" ${asset.status==='Cần sửa chữa' ? 'selected' : '' }>Cần sửa
                                    chữa</option>
                                <option value="Hỏng" ${asset.status==='Hỏng' ? 'selected' : '' }>Hỏng</option>
                            </select>
                        </div>

                        <div class="info-label">Giá trị:</div>
                        <div class="info-value">${formatCurrency(asset.initialValue)}</div>

                        <div class="info-label">Kiểm kê:</div>
                        <div class="info-value">${asset.checked ? '✅ Đã kiểm kê' : '❌ Chưa kiểm kê'}</div>

                        ${asset.checked ? `
                        <div class="info-label">Người kiểm kê:</div>
                        <div class="info-value">${asset.checkedBy}</div>

                        <div class="info-label">Thời gian:</div>
                        <div class="info-value">${new Date(asset.checkedTime).toLocaleString('vi-VN')}</div>
                        ` : ''}
                    </div>

                    <div class="btn-group" style="margin-top: 20px;">
                        ${!asset.checked ? `
                        <button class="btn btn-success" onclick="confirmInventory('${code}')">
                            ✅ Xác nhận kiểm kê
                        </button>
                        ` : `
                        <button class="btn btn-warning" onclick="cancelInventory('${code}')">
                            ↩️ Hủy kiểm kê
                        </button>
                        `}
                        <button class="btn btn-primary" onclick="updateAsset('${code}')">
                            💾 Cập nhật thông tin
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">
                            ❌ Đóng
                        </button>
                    </div>
                    `;

            modal.classList.add('active');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('asset-modal').classList.remove('active');
        }

        // === PHẦN 7: INVENTORY FUNCTIONS ===

        // Confirm Inventory
        async function confirmInventory(code) {
            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            if (!inspectorName) {
                alert('⚠️ Vui lòng nhập tên người kiểm kê trong tab "Kỳ kiểm kê"!');
                return;
            }

            asset.checked = true;
            asset.checkedBy = inspectorName;
            asset.checkedTime = new Date().toISOString();
            asset.location = document.getElementById('edit-location').value;
            asset.status = document.getElementById('edit-status').value;

            await saveAssets();
            displayAssets();
            updateDashboard();
            closeModal();

            await addActivity('Kiểm kê', `Đã kiểm kê tài sản ${code}`);

            alert('✅ Đã xác nhận kiểm kê thành công!');
        }

        // Cancel Inventory
        async function cancelInventory(code) {
            if (!confirm('Bạn có chắc muốn hủy kiểm kê tài sản này?')) return;

            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            asset.checked = false;
            asset.checkedBy = '';
            asset.checkedTime = '';

            await saveAssets();
            displayAssets();
            updateDashboard();
            closeModal();

            await addActivity('Hủy kiểm kê', `Đã hủy kiểm kê tài sản ${code}`);
        }

        // Update Asset
        async function updateAsset(code) {
            const asset = assets.find(a => a.code === code);
            if (!asset) return;

            asset.location = document.getElementById('edit-location').value;
            asset.status = document.getElementById('edit-status').value;

            await saveAssets();
            displayAssets();
            closeModal();

            await addActivity('Cập nhật', `Đã cập nhật thông tin tài sản ${code}`);

            alert('✅ Đã cập nhật thông tin thành công!');
        }

        // === PHẦN 8: DASHBOARD & STATISTICS ===

        // Update Dashboard
        function updateDashboard() {
            const total = assets.length;
            const checked = assets.filter(a => a.checked).length;
            const unchecked = total - checked;
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;

            document.getElementById('total-assets').textContent = total;
            document.getElementById('checked-assets').textContent = checked;
            document.getElementById('unchecked-assets').textContent = unchecked;
            document.getElementById('inventory-period').textContent = currentPeriod || '--';

            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            displayRecentActivities();
        }

        // === PHẦN 9: PERIOD MANAGEMENT ===

        // Create New Period
        async function createNewPeriod() {
            const newPeriod = document.getElementById('new-period').value.trim();

            if (!newPeriod) {
                alert('⚠️ Vui lòng nhập tên kỳ kiểm kê!');
                return;
            }

            if (currentPeriod && !confirm(`Bạn có chắc muốn tạo kỳ mới "${newPeriod}"? Kỳ hiện tại
                    "${currentPeriod}" sẽ được lưu lại.`)) {
                return;
            }

            currentPeriod = newPeriod;
            localStorage.setItem('currentPeriod', currentPeriod);
            document.getElementById('current-period').value = currentPeriod;
            document.getElementById('new-period').value = '';

            await addActivity('Tạo kỳ mới', `Đã tạo kỳ kiểm kê "${newPeriod}"`);
            updateDashboard();

            alert(`✅ Đã tạo kỳ kiểm kê mới: ${newPeriod}`);
        }

        // Reset Inventory
        async function resetInventory() {
            if (!confirm('⚠️ CẢNH BÁO: Việc reset sẽ xóa toàn bộ dữ liệu kiểm kê hiện tại. Bạn có chắc chắn?')) {
                return;
            }

            if (!confirm('⚠️ XÁC NHẬN LẦN 2: Tất cả dữ liệu kiểm kê sẽ bị xóa. Tiếp tục?')) {
                return;
            }

            // Reset all assets
            assets.forEach(asset => {
                asset.checked = false;
                asset.checkedBy = '';
                asset.checkedTime = '';
            });

            await saveAssets();
            displayAssets();
            updateDashboard();

            await addActivity('Reset kiểm kê', 'Đã reset toàn bộ dữ liệu kiểm kê');

            alert('✅ Đã reset dữ liệu kiểm kê thành công!');
        }

        // Save Inspector Name
        function saveInspector() {
            inspectorName = document.getElementById('inspector-name').value.trim();

            if (!inspectorName) {
                alert('⚠️ Vui lòng nhập tên người kiểm kê!');
                return;
            }

            localStorage.setItem('inspectorName', inspectorName);
            alert(`✅ Đã lưu người kiểm kê: ${inspectorName}`);
        }

        // === PHẦN 10: QR CODE GENERATION ===

        // Generate QR Codes
        function generateAllQR() {
            if (assets.length === 0) {
                alert('⚠️ Chưa có dữ liệu tài sản. Vui lòng upload file Excel!');
                return;
            }

            const container = document.getElementById('qr-preview');
            container.innerHTML = '';

            assets.forEach(asset => {
                const qrItem = document.createElement('div');
                qrItem.className = 'qr-item';
                qrItem.innerHTML = `
                    <div class="qr-info">
                        <strong>Mã: ${asset.code}</strong><br>
                        ${asset.nameVi || ''}<br>
                        Model: ${asset.model || ''}<br>
                        Serial: ${asset.serial || ''}<br>
                        Bộ phận: ${asset.department || ''}
                    </div>
                    <div id="qr-${asset.code}" class="qr-code"></div>
                    `;
                container.appendChild(qrItem);

                // Generate QR Code
                new QRCode(document.getElementById(`qr-${asset.code}`), {
                    text: asset.code,
                    width: 150,
                    height: 150,
                    correctLevel: QRCode.CorrectLevel.H
                });
            });

            alert(`✅ Đã tạo ${assets.length} mã QR!`);
        }

        // Print QR Codes
        function printQRCodes() {
            if (document.getElementById('qr-preview').innerHTML === '') {
                alert('⚠️ Vui lòng tạo mã QR trước khi in!');
                return;
            }

            window.print();
        }

        // === PHẦN 11: QR SCANNER ===

        // Start QR Scanner
        function startScanning() {
            const config = {
                fps: 10,
                qrbox: {
                    width: 250,
                    height: 250
                },
                aspectRatio: 1.0
            };

            html5QrcodeScanner = new Html5Qrcode("reader");

            html5QrcodeScanner.start({
                    facingMode: "environment"
                },
                config,
                onScanSuccess,
                onScanFailure
            );

            document.getElementById('start-scan-btn').style.display = 'none';
            document.getElementById('stop-scan-btn').style.display = 'inline-block';
        }

        // Stop QR Scanner
        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    document.getElementById('start-scan-btn').style.display = 'inline-block';
                    document.getElementById('stop-scan-btn').style.display = 'none';
                }).catch(err => console.error(err));
            }
        }

        // On Scan Success
        async function onScanSuccess(decodedText, decodedResult) {
            const asset = assets.find(a => a.code === decodedText);

            if (!asset) {
                alert(`⚠️ Không tìm thấy tài sản với mã: ${decodedText}`);
                return;
            }

            // Stop scanning temporarily
            stopScanning();

            // Show asset details
            showAssetDetails(decodedText);

            // Auto confirm if not checked
            if (!asset.checked) {
                setTimeout(() => {
                    if (confirm(`Xác nhận kiểm kê tài sản ${decodedText}?`)) {
                        confirmInventory(decodedText);
                    }
                }, 500);
            }
        }

        // On Scan Failure
        function onScanFailure(error) {
            // Ignore scan failures (continuous scanning)
        }

        // === PHẦN 12: EXPORT FUNCTIONS ===

        // Export to Excel
        function exportToExcel() {
            if (assets.length === 0) {
                alert('⚠️ Không có dữ liệu để xuất!');
                return;
            }

            const exportData = assets.map(asset => ({
                'Mã tài sản': asset.code,
                'Tên tiếng Việt': asset.nameVi,
                'Tên tiếng Anh': asset.nameEn,
                'Loại': asset.type,
                'Model': asset.model,
                'Serial': asset.serial,
                'Tech Code': asset.techCode,
                'Bộ phận': asset.department,
                'Vị trí': asset.location,
                'Tình trạng': asset.status,
                'Giá trị': asset.initialValue,
                'Đã kiểm kê': asset.checked ? 'Có' : 'Không',
                'Người kiểm kê': asset.checkedBy,
                'Thời gian kiểm kê': asset.checkedTime ? new Date(asset.checkedTime).toLocaleString(
                    'vi-VN') : ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Tài sản');

            const filename = `Kiem_ke_tai_san_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);

            addActivity('Xuất báo cáo', `Đã xuất file Excel ${filename}`);
        }

        // Export Checked Assets
        function exportCheckedAssets() {
            const checkedAssets = assets.filter(a => a.checked);

            if (checkedAssets.length === 0) {
                alert('⚠️ Không có tài sản nào đã kiểm kê!');
                return;
            }

            const exportData = checkedAssets.map(asset => ({
                'Mã tài sản': asset.code,
                'Tên tiếng Việt': asset.nameVi,
                'Tên tiếng Anh': asset.nameEn,
                'Loại': asset.type,
                'Model': asset.model,
                'Serial': asset.serial,
                'Bộ phận': asset.department,
                'Vị trí': asset.location,
                'Tình trạng': asset.status,
                'Người kiểm kê': asset.checkedBy,
                'Thời gian kiểm kê': new Date(asset.checkedTime).toLocaleString('vi-VN')
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Đã kiểm kê');

            const filename = `Da_kiem_ke_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Export Unchecked Assets
        function exportUncheckedAssets() {
            const uncheckedAssets = assets.filter(a => !a.checked);

            if (uncheckedAssets.length === 0) {
                alert('⚠️ Tất cả tài sản đã được kiểm kê!');
                return;
            }

            const exportData = uncheckedAssets.map(asset => ({
                'Mã tài sản': asset.code,
                'Tên tiếng Việt': asset.nameVi,
                'Tên tiếng Anh': asset.nameEn,
                'Loại': asset.type,
                'Model': asset.model,
                'Serial': asset.serial,
                'Bộ phận': asset.department,
                'Vị trí': asset.location,
                'Tình trạng': asset.status
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Chưa kiểm kê');

            const filename = `Chua_kiem_ke_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // === PHẦN 13: UTILITY FUNCTIONS ===

        // Download Template
        function downloadTemplate() {
            const template = [{
                'Code': 'TS001',
                'Tên tài sản Tiếng Việt': 'Máy tính xách tay',
                'Tên tiếng anh': 'Laptop',
                'Loại': 'IT Equipment',
                'Model': 'Dell Latitude 5520',
                'Serial': 'ABC123456',
                'Tech code': 'IT-001',
                'Ngày bắt đầu': '01/01/2024',
                'Thời gian sử dụng': '48',
                'Ngày kết thúc': '01/01/2028',
                'Khách hàng': 'Nội bộ',
                'NCC': 'Dell Vietnam',
                'Nguồn cố': 'Mua mới',
                'Bộ phận sử dụng': 'IT Department',
                'Giá trị ban đầu': '25000000',
                'Tình trạng': 'Tốt',
                'Vị trí': 'Tầng 2 - Phòng IT'
            }];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');

            XLSX.writeFile(wb, 'Template_Import_Tai_San.xlsx');
        }

        // Format Currency
        function formatCurrency(value) {
            if (!value) return '';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(value);
        }

        // Show/Hide Loading
        function showLoading() { // Show/Hide Loading
            function showLoading() {
                document.getElementById('loading').classList.add('active');
            }

            function hideLoading() {
                document.getElementById('loading').classList.remove('active');
            }

            // === PHẦN 14: EVENT LISTENERS & INITIALIZATION ===

            // Initialize app when DOM is ready
            document.addEventListener('DOMContentLoaded', initApp);

            // Handle window click for modal
            window.onclick = function (event) {
                const modal = document.getElementById('asset-modal');
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Prevent form submission on enter
            document.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });

            // Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
            }
    </script>
</body>

</html>